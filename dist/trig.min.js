"use strict";function Init(){}function Core(worker){var _this=this;this.world=new GameWorld,this.actorManager=new ActorManager({world:this.world}),this.renderBus=new RenderBus(worker),this.scene=new GameScene({world:this.world,actorManager:this.actorManager}),this.startGameLoop(),this.scene.fillScene(),this.logicTicks=0,setInterval(function(){console.log("logicTicks: ",_this.logicTicks),_this.logicTicks=0},1e3)}function GameScene(config){if(Object.assign(this,config),!this.world)throw new Error("No world specified for Logic GameScene");if(!this.actorManager)throw new Error("No actorManager specified for Logic GameScene")}function RenderBus(worker){if(!worker)throw new Error("No worker object specified for Logic Render Bus");this.worker=worker}function GameWorld(config){p2.World.apply(this,arguments),this.transferArray=new Float32Array(2e4),config=config||{},this.gravity=[0,0],this.islandSplit=!1,Object.assign(this,config)}function BaseActor(configArray){if(this.body=this.createBody(configArray),!this.body)throw new Error("No body defined for Logic Actor!");this.body.position=[configArray[1]||0,configArray[2]||0],this.body.angle=configArray[3]||0,this.acceleration=0,this.turnSpeed=0,this.thrust=0,this.rotationForce=0}function LightActor(configArray){configArray=configArray||[],BaseActor.apply(this,arguments)}function MookActor(configArray){configArray=configArray||[],BaseActor.apply(this,arguments),this.acceleration=40,this.turnSpeed=.3,this.thrust=0,this.rotationForce=0}function ShipActor(configArray){configArray=configArray||[],BaseActor.apply(this,arguments)}function BaseBody(config){if(p2.Body.apply(this,arguments),!config.actor)throw"ERROR: no actor specified for body!";config.position=config.position||[0,0],config.angle=Utils.degToRad(config.angle||0),Object.assign(this,config),this.createShape()}function ActorManager(config){if(config=config||{},this.storage={},this.world=null,this.factory=config.factory||new ActorFactory,this.currentId=1,Object.assign(this,config),!this.world)throw new Error("No world for Logic ActorManager!")}function Camera(config){this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.VIEW_ANGLE=45,this.ASPECT=this.WIDTH/this.HEIGHT,this.NEAR=.1,this.FAR=1e4,config=config||{},Object.assign(this,config),THREE.PerspectiveCamera.call(this,this.VIEV_ANGLE,this.ASPECT,this.NEAR,this.FAR),this.position.z=300}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function Core(logicCore){if(!logicCore)throw new Error("Logic core initialization failure!");this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.FRAMERATE=60,this.renderTicks=0,this.logicWorker=logicCore,this.initRenderer(),this.initAssets()}function LogicBus(config){if(config=config||{},Object.assign(this,config),!this.logicWorker)throw new Error("No logicWorker object specified for LogicBus!");if(!this.actorManager)throw new Error("No actorManager object specified for LogicBus!");this.logicWorker.onmessage=this.updateFromLogic.bind(this)}function BaseActor(configArray){this.updateFromLogic(configArray),this.positionZ=10,this.mesh=this.createMesh(),this.light=this.createLight()}function LightActor(){BaseActor.apply(this,arguments)}function MookActor(){BaseActor.apply(this,arguments)}function ShipActor(){BaseActor.apply(this,arguments)}function BaseLight(config){if(THREE.PointLight.apply(this,arguments),config=config||{},this.zOffset=10,this.distance=50,this.color=config.color||new THREE.Color(16777215),this.followActor=!0,Object.assign(this,config),this.color instanceof THREE.Color==!1)throw new Error("No color for a light!")}function BaseMesh(config){THREE.Mesh.apply(this,arguments),this.followActor=!0,this.angleOffset=0,config=config||{},Object.assign(this,config)}function ShipMesh(config){BaseMesh.apply(this,arguments),this.angleOffset=180,config=config||{},config.geometry=ModelStore.get("ship").geometry,config.material=ModelStore.get("ship").material,Object.assign(this,config)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function ActorFactory(){var _actorMap;this.actorMap=(_actorMap={},_defineProperty(_actorMap,ActorFactory.SHIP_ACTOR,ShipActor),_defineProperty(_actorMap,ActorFactory.MOOK_ACTOR,MookActor),_defineProperty(_actorMap,ActorFactory.LIGHT_ACTOR,LightActor),_actorMap)}function ActorManager(config){if(config=config||{},this.storage=Object.create(null),this.scene=null,this.factory=config.factory||new ActorFactory,Object.assign(this,config),!this.scene)throw new Error("No scene for Renderer ActorManager!")}function ActorStorage(size){this.storage=Array.apply(null,Array(size)).map(function(){}),this.holes=Array.apply(null,Array(size)).map(function(){})}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var gameCore;Init.prototype.start=function(){var logicWorker=new Worker("dist/b/logic/Init.js"),core=new Core(logicWorker);gameCore=core};var Utils={makeRandomColor:function(){var colors=["","",""];colors.forEach(function(color,index){var newColor=Math.floor(256*Math.random()).toString(16);colors[index]=1===newColor.length?"0"+newColor:newColor});var color="0x"+colors.join("");return Number(color)},degToRad:function(degrees){return degrees*(Math.PI/180)},radToDeg:function(radians){return radians*(180/Math.PI)},getRandomFloat:function(min,max){if(min>max)throw"ERROR: getRandomFloat min > max";return Math.random()*(max-min)+min},getRandomInteger:function(min,max){if(min>max)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(max-min+1)+min)},rand:function(min,max){return this.getRandomInteger(min,max)},mixin:function(receiver,donor){for(var prop in donor.prototype)receiver[prop]=donor.prototype[prop]},uptrunc:function(x){return 0>x?Math.floor(x):Math.ceil(x)}};Function.prototype.extend||(Function.prototype.extend=function(oldClass){this.prototype=Object.create(oldClass.prototype),this.prototype.constructor=oldClass}),Core.prototype.createWorld=function(){return new p2.World({gravity:[1,0],islandSplit:!1})},Core.prototype.processGameLogic=function(){this.world.step(1/30),this.actorManager.update(),this.renderBus.postMessage(this.world.makeUpdateData()),this.logicTicks++},Core.prototype.startGameLoop=function(){var logicLoop=new THREEx.PhysicsLoop(59);logicLoop.add(this.processGameLogic.bind(this)),logicLoop.start()},GameScene.prototype.fillScene=function(){for(var i=0;1e3>i;i++)this.actorManager.addNew([ActorFactory.MOOK_ACTOR,Utils.rand(-200,200),Utils.rand(-200,200),Utils.rand(0,360)]);console.log("scene complete")},"function"==typeof importScripts&&(importScripts("../../../lib/p2.min.js"),importScripts("../../../lib/threex.loop.js"),importScripts("../Utils.js"),importScripts("../logic/Core.js"),importScripts("../logic/RenderBus.js"),importScripts("../logic/World.js"),importScripts("../logic/GameScene.js"),importScripts("../logic/actorManagement/ActorManager.js"),importScripts("../logic/actor/BaseActor.js"),importScripts("../logic/actor/MookActor.js"),importScripts("../logic/actor/ShipActor.js"),importScripts("../logic/actor/LightActor.js"),importScripts("../logic/actor/body/BaseBody.js"),importScripts("../renderer/actorManagement/ActorFactory.js"),self.core=new Core(self)),RenderBus.prototype.postMessage=function(message){this.worker.postMessage(message)},GameWorld.extend(p2.World),GameWorld.prototype.makeUpdateData=function(){for(var transferArray=this.transferArray,i=0;i<this.bodies.length;i++){var body=this.bodies[i];transferArray[5*i]=body.storageId,transferArray[5*i+1]=body.classId,transferArray[5*i+2]=body.position[0],transferArray[5*i+3]=body.position[1],transferArray[5*i+4]=body.angle}return{length:this.bodies.length,transferArray:this.transferArray}},BaseActor.prototype.createBody=function(configArray){return null},BaseActor.prototype.update=function(){this.customUpdate()},BaseActor.prototype.customUpdate=function(){},LightActor.extend(BaseActor),MookActor.extend(BaseActor),MookActor.prototype.createBody=function(){return new BaseBody({actor:this,mass:1,damping:.75,angularDamping:0})},MookActor.prototype.customUpdate=function(){this.actorLogic(),0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0},MookActor.prototype.actorLogic=function(){if(100===Utils.rand(0,100)&&(this.rotationForce=Utils.rand(-2,2)),Utils.rand(0,100)>97){var thrustRand=Utils.rand(0,100);thrustRand>20?this.thrust=1:2>=thrustRand?this.thrust=-1:this.thrust=0}},ShipActor.extend(BaseActor),BaseBody.extend(p2.Body),BaseBody.prototype.createShape=function(){this.addShape(new p2.Box({height:5,width:5}))},ActorManager.prototype.addNew=function(actorParameters){var actor=this.factory.create(actorParameters);actor.body.storageId=this.currentId,actor.body.classId=actorParameters[0],this.storage[this.currentId]=actor,this.currentId++,this.world.addBody(actor.body)},ActorManager.prototype.update=function(){for(var actor in this.storage)this.storage[actor].update()},Camera.extend(THREE.PerspectiveCamera),Camera.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1]),this.controls&&(this.controls.moveState.scrollUp&&(this.position.z+=this.controls.moveState.scrollUp),this.controls.moveState.scrollDown&&(this.position.z-=this.controls.moveState.scrollDown))};var TopDownControls=function TopDownControls(domElement){function bind(scope,fn){return function(){fn.apply(scope,arguments)}}function contextmenu(event){event.preventDefault()}_classCallCheck(this,TopDownControls),this.scrollDuration=4,this.scrollFallOffPercent=10,this.domElement=void 0!==domElement?domElement:document,domElement&&this.domElement.setAttribute("tabindex",-1),this.moveState={},this.keys={87:"w",83:"s",65:"a",68:"d",37:"left",38:"up",39:"right",40:"down",1001:"scrollUp",1002:"scrollDown"},Object.keys(this.keys).forEach(function(key){this.moveState[this.keys[key]]=0}.bind(this)),this.keydown=function(event){event.altKey||this.keys.hasOwnProperty(event.keyCode)&&(this.moveState[this.keys[event.keyCode]]+=1)},this.keyup=function(event){this.keys.hasOwnProperty(event.keyCode)&&(this.moveState[this.keys[event.keyCode]]=0)},this.mouseWheel=function(event){this.moveState.scrollUp=event.deltaY>0?this.scrollDuration:0,this.moveState.scrollDown=event.deltaY<0?this.scrollDuration:0},this.handleEvent=function(event){"function"==typeof this[event.type]&&this[event.type](event)},this.update=function(delta){Object.keys(this.moveState).forEach(function(key){switch(key){case"scrollUp":case"scrollDown":this.moveState[key]>0&&(this.moveState[key]*=1-this.scrollFallOffPercent/100),this.moveState[key]<.5&&(this.moveState[key]=0)}}.bind(this))},this.dispose=function(){this.domElement.removeEventListener("contextmenu",contextmenu,!1),this.domElement.removeEventListener("wheel",_wheel,!1),window.removeEventListener("keydown",_keydown,!1),window.removeEventListener("keyup",_keyup,!1)};var _keydown=bind(this,this.keydown),_keyup=bind(this,this.keyup),_wheel=bind(this,this.mouseWheel);this.domElement.addEventListener("contextmenu",contextmenu,!1),this.domElement.addEventListener("wheel",_wheel,!1),window.addEventListener("keydown",_keydown,!1),window.addEventListener("keyup",_keyup,!1)};Core.prototype.initRenderer=function(){this.renderer=this.makeRenderer(),this.controls=new TopDownControls(this.renderer.domElement),this.camera=this.makeCamera(),this.scene=this.makeScene(),this.scene.add(this.camera),this.autoResize(this.renderer,this.camera),this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="0px",this.actorManager=new ActorManager({scene:this.scene}),this.logicBus=new LogicBus({logicWorker:this.logicWorker,actorManager:this.actorManager}),this.gameScene=new GameScene({core:this,scene:this.scene,logicBus:this.logicBus,actorManager:this.actorManager}),document.body.appendChild(this.renderer.domElement),document.body.appendChild(this.stats.domElement)},Core.prototype.makeCamera=function(){console.log("making camera");var camera=new Camera({controls:this.controls});return camera},Core.prototype.makeScene=function(camera){return new THREE.Scene},Core.prototype.makeRenderer=function(){var renderer=new THREE.WebGLRenderer;return renderer.setSize(this.WIDTH,this.HEIGHT),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.BasicShadowMap,renderer},Core.prototype.autoResize=function(renderer,camera){var callback=function(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()};return window.addEventListener("resize",callback,!1),{stop:function(){window.removeEventListener("resize",callback)}}},Core.prototype.initAssets=function(){this.modelLoader=new ModelLoader(ModelList.models),this.modelLoader.addEventListener("loaded",this.onLoaded.bind(this)),this.modelLoader.loadModels()},Core.prototype.onLoaded=function(event){ModelStore.loadBatch(this.modelLoader.getBatch()),this.modelLoader.clearBatch(),this.continueInit()},Core.prototype.continueInit=function(){var _this=this;this.gameScene.make(),setInterval(function(){console.log("renderTicks: ",_this.renderTicks),_this.renderTicks=0},1e3);var renderLoop=new THREEx.RenderingLoop;renderLoop.add(this.render.bind(this)),renderLoop.start()},Core.prototype.render=function(){this.gameScene.update(),this.actorManager.update(),this.controls.update(),this.camera.update(),this.renderTicks++,this.renderer.render(this.scene,this.camera),this.stats.update()},LogicBus.prototype.updateFromLogic=function(message){this.actorManager.updateFromLogic(message.data)},BaseActor.prototype.update=function(){this.mesh&&this.mesh.update(),this.light&&this.light.update()},BaseActor.prototype.updateFromLogic=function(configArray){this.position=[configArray[2]||0,configArray[3]||0],this.angle=configArray[4]||0},BaseActor.prototype.createMesh=function(){return null},BaseActor.prototype.createLight=function(){return null},BaseActor.prototype.addToScene=function(scene){this.mesh&&scene.add(this.mesh),this.light&&scene.add(this.light)},BaseActor.prototype.removeFromScene=function(scene){this.mesh&&scene.remove(this.mesh),this.light&&scene.remove(this.light)},LightActor.extend(BaseActor),LightActor.prototype.createLight=function(){return new BaseLight({actor:this,intensity:0})},MookActor.extend(BaseActor),MookActor.prototype.createMesh=function(){return new ShipMesh({actor:this})},ShipActor.prototype.createMesh=function(){return new ShipMesh},ShipActor.extend(BaseActor),BaseLight.extend(THREE.PointLight),BaseLight.prototype.update=function(){this.actor&&this.followActor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ+this.zOffset)},BaseMesh.extend(THREE.Mesh),BaseMesh.prototype.update=function(){this.actor&&this.followActor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ,this.rotation.z=this.actor.angle+this.angleOffset)},ShipMesh.extend(BaseMesh),ActorFactory.SHIP_ACTOR=1,ActorFactory.MOOK_ACTOR=2,ActorFactory.LIGHT_ACTOR=3,ActorFactory.prototype.create=function(actorDataArray){return new this.actorMap[actorDataArray[0]](actorDataArray)},ActorManager.prototype.update=function(){for(var actor in this.storage)this.storage[actor].update()},ActorManager.prototype.updateFromLogic=function(dataObject){for(var length=dataObject.length,dataArray=dataObject.transferArray,i=0;length>i;i++)this.storage[dataArray[5*i]]?this.storage[dataArray[5*i]].updateFromLogic([dataArray[5*i],dataArray[5*i+1],dataArray[5*i+2],dataArray[5*i+3],dataArray[5*i+4]]):this.createActor([dataArray[5*i],dataArray[5*i+1],dataArray[5*i+2],dataArray[5*i+3],dataArray[5*i+4]])},ActorManager.prototype.createActor=function(actorData){var actorId=actorData.shift(),actor=this.factory.create(actorData);this.storage[actorId]=actor,actor.addToScene(this.scene)};var ModelList={models:["/models/ship.json"]},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ModelLoader=function(){function ModelLoader(modelPaths){if(_classCallCheck(this,ModelLoader),!modelPaths)throw"ERROR: No model paths have been specified for the loader!";this.modelPaths=modelPaths,this.batch={},this.loaded=!0,Utils.mixin(this,THREE.EventDispatcher)}return _createClass(ModelLoader,[{key:"loadModels",value:function(){var _this=this;if(!this.loaded)throw"ERROR: ModelLoader is still busy loading previous batch!";this.loaded=!1;var loader=new THREE.JSONLoader;this.modelPaths.forEach(function(modelPath,index){_this.batch[_this._getModelName(modelPath)]={geometry:null,material:null,loaded:!1},loader.load(modelPath,function(geometry,material){var model=_this.batch[_this._getModelName(modelPath)];model.geometry=geometry,model.material=material,model.loaded=!0,_this.checkIfLoaded()&&_this._doneAction()})})}},{key:"checkIfLoaded",value:function(){var result=!0;for(var modelName in this.batch)if(!this.batch[modelName].loaded)return result=!1,!1;return result}},{key:"getBatch",value:function(){return this.batch}},{key:"clearBatch",value:function(){this.batch={}}},{key:"_doneAction",value:function(){this.loaded=!0,this.dispatchEvent({type:"loaded"})}},{key:"_getModelName",value:function(path){var name=path.split(".")[0].split("/").pop();if(!name)throw"ERROR: Bad model path: "+path;return name}}]),ModelLoader}(),ModelStore={_materials:{},_geometries:{},get:function(name){return{geometry:this._geometries[name],material:this._materials[name]}},loadBatch:function(batch){console.log(this),Object.keys(batch).forEach(function(modelName){this._addGeometry(modelName,batch[modelName].geometry),this._addMaterial(modelName,batch[modelName].material)}.bind(this))},_addGeometry:function(name,geometry){if(geometry instanceof THREE.Geometry!=!0)throw"ERROR - geometry not instance of THREE.Geometry";this._geometries[name]=geometry},_addMaterial:function(name,material){if(!material)throw"ERROR - no material specified";this._materials[name]=material instanceof Array?material[0]:material}},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),GameScene=function(){function GameScene(config){_classCallCheck(this,GameScene),Object.assign(this,config),this.lightCounter=0}return _createClass(GameScene,[{key:"makeWalls",value:function(){for(var wall,walls=[],material=new THREE.MeshLambertMaterial({color:16777215}),wallGeometry=new THREE.BoxGeometry(10,100,5,20,20),i=0;100>i;i++)wall=new THREE.Mesh(wallGeometry,material),wall.position.x=Utils.rand(-300,300),wall.position.y=Utils.rand(-300,300),wall.position.z=0,wall.rotateZ(Utils.degToRad(Utils.rand(0,360))),walls.push(wall);var combine=new THREE.Geometry;return walls.forEach(function(w){w.updateMatrix(),combine.merge(w.geometry,w.matrix)}),new THREE.Mesh(combine,material)}},{key:"make",value:function(){var combine=new THREE.Geometry,geometry=new THREE.PlaneGeometry(1e3,1e3,200,200),material=new THREE.MeshLambertMaterial({color:16777215}),floor=new THREE.Mesh(geometry,material);floor.updateMatrix(),combine.merge(floor.geometry,floor.matrix);var walls=this.makeWalls();combine.merge(walls.geometry,walls.matrix);var combinedObject=new THREE.Mesh(combine,material);combinedObject.matrixAutoUpdate=!1,combinedObject.updateMatrix(),this.scene.add(combinedObject),this.emergencyLight=new THREE.PointLight(8912896,1,200),this.emergencyLight.position.set(0,0,50),this.scene.add(this.emergencyLight);for(var i=0;5>i;i++){var l=new THREE.PointLight(16777215,1,100);l.position.set(Utils.rand(-200,200),Utils.rand(-200,200),20),this.scene.add(l)}}},{key:"update",value:function(){}}]),GameScene}();
//# sourceMappingURL=sourceMap.map