"use strict";function Camera(actor){this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.VIEW_ANGLE=45,this.ASPECT=this.WIDTH/this.HEIGHT,this.NEAR=.1,this.FAR=1e4,THREE.PerspectiveCamera.call(this,this.VIEV_ANGLE,this.ASPECT,this.NEAR,this.FAR),this.position.z=300,actor&&(this.actor=actor)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function Init(){}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function MasterManager(){this.managers={},this.collisionMap={},this.collision=new Collisions(this)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function Collisions(masterManager){this.masterManager=masterManager,this.collisionClassMap=this.makeCollisionClassMap(),this.fineCheckCount=0,this.coarseCheckCount=0,this.counter=0}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Camera.extend(THREE.PerspectiveCamera),Camera.prototype.update=function(){this.actor&&(this.position.x=this.actor.position.x,this.position.y=this.actor.position.y)};var TopDownControls=function TopDownControls(object,domElement){function bind(scope,fn){return function(){fn.apply(scope,arguments)}}function contextmenu(event){event.preventDefault()}_classCallCheck(this,TopDownControls),this.scrollDuration=4,this.scrollFallOffPercent=10,this.domElement=void 0!==domElement?domElement:document,domElement&&this.domElement.setAttribute("tabindex",-1),this.moveState={},this.keys={87:"w",83:"s",65:"a",68:"d",37:"left",38:"up",39:"right",40:"down",1001:"scrollUp",1002:"scrollDown"},Object.keys(this.keys).forEach(function(key){this.moveState[this.keys[key]]=0}.bind(this)),this.keydown=function(event){event.altKey||this.keys.hasOwnProperty(event.keyCode)&&(this.moveState[this.keys[event.keyCode]]+=1)},this.keyup=function(event){this.keys.hasOwnProperty(event.keyCode)&&(this.moveState[this.keys[event.keyCode]]=0)},this.mouseWheel=function(event){this.moveState.scrollUp=event.deltaY>0?this.scrollDuration:0,this.moveState.scrollDown=event.deltaY<0?this.scrollDuration:0},this.handleEvent=function(event){"function"==typeof this[event.type]&&this[event.type](event)},this.update=function(delta){Object.keys(this.moveState).forEach(function(key){switch(key){case"scrollUp":case"scrollDown":this.moveState[key]>0&&(this.moveState[key]*=1-this.scrollFallOffPercent/100),this.moveState[key]<.5&&(this.moveState[key]=0)}}.bind(this))},this.dispose=function(){this.domElement.removeEventListener("contextmenu",contextmenu,!1),this.domElement.removeEventListener("wheel",_wheel,!1),window.removeEventListener("keydown",_keydown,!1),window.removeEventListener("keyup",_keyup,!1)};var _keydown=bind(this,this.keydown),_keyup=bind(this,this.keyup),_wheel=bind(this,this.mouseWheel);this.domElement.addEventListener("contextmenu",contextmenu,!1),this.domElement.addEventListener("wheel",_wheel,!1),window.addEventListener("keydown",_keydown,!1),window.addEventListener("keyup",_keyup,!1)},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Core=function(){function Core(){_classCallCheck(this,Core),this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.FRAMERATE=60,this.logicTicks=0,this.renderTicks=0}return _createClass(Core,[{key:"run",value:function(){this.loadAssets()}},{key:"loadAssets",value:function(){this.modelLoader=new ModelLoader(ModelList.models),this.modelLoader.addEventListener("loaded",this.onLoaded.bind(this)),this.modelLoader.loadModels()}},{key:"onLoaded",value:function(event){ModelStore.loadBatch(this.modelLoader.getBatch()),this.modelLoader.clearBatch(),this.runAfterAssetsLoaded()}},{key:"makeManagers",value:function(){this.masterManager=new MasterManager,this.masterManager.add(new Manager(this.scene,"ship"),"ship"),this.masterManager.add(new Manager(this.scene),"light")}},{key:"runAfterAssetsLoaded",value:function(){var _this=this;this.makeManagers(),this.gameLoop=new GameLoop(this.controls,this.camera);var actor=new PlayerActor(this.controls);this.camera.actor=actor,this.masterManager.get("ship").add(actor),this.gameScene.make(),setInterval(function(){console.log("logicTicks:",_this.logicTicks," renderTicks: ",_this.renderTicks),_this.logicTicks=0,_this.renderTicks=0},1e3);var logicLoop=new THREEx.RenderingLoop;logicLoop.add(this.processGameLogic.bind(this));var renderLoop=new THREEx.RenderingLoop;renderLoop.add(this.render.bind(this)),logicLoop.start(),renderLoop.start()}},{key:"setRenderer",value:function(){this.renderer=this.makeRenderer(),this.camera=this.makeCamera(),this.scene=this.makeScene(),this.scene.add(this.camera),this.controls=new TopDownControls(this.camera),this.controls.domElement=this.renderer.domElement,this.autoResize(this.renderer,this.camera),this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="0px",this.gameScene=new GameScene(this,this.scene),document.body.appendChild(this.renderer.domElement),document.body.appendChild(this.stats.domElement)}},{key:"makeCamera",value:function(){var camera=new Camera;return camera}},{key:"makeScene",value:function(camera){return new THREE.Scene}},{key:"makeRenderer",value:function(){var renderer=new THREE.WebGLRenderer;return renderer.setSize(this.WIDTH,this.HEIGHT),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.BasicShadowMap,renderer}},{key:"processGameLogic",value:function(){this.logicTicks++,this.gameLoop.update(),this.masterManager.update(),this.gameScene.update(),this.controls.update(),this.camera.update()}},{key:"render",value:function(){this.renderTicks++,this.renderer.render(this.scene,this.camera),this.stats.update()}},{key:"autoResize",value:function(renderer,camera){var callback=function(){renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix()};return window.addEventListener("resize",callback,!1),{stop:function(){window.removeEventListener("resize",callback)}}}},{key:"rendererReport",value:function(){this.time||(this.time=0),this.time++,this.time>120&&(this.time=0,console.info(this.renderer.info.render.faces),console.info(this.renderer.info.memory.textures),console.info(this.renderer.info.render.vertices),console.info(this.renderer.info.memory.geometries),console.info(this.renderer.info.render.calls))}}]),Core}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),GameLoop=function(){function GameLoop(controls,camera){_classCallCheck(this,GameLoop),this.controls=controls,this.camera=camera}return _createClass(GameLoop,[{key:"update",value:function(){this.controls.moveState.scrollUp&&(this.camera.position.z+=this.controls.moveState.scrollUp),this.controls.moveState.scrollDown&&(this.camera.position.z-=this.controls.moveState.scrollDown)}}]),GameLoop}(),gameCore;Init.prototype.start=function(){console.log("init start");var core=new Core;core.setRenderer(),core.run(),console.log("init end"),gameCore=core};var Utils={makeRandomColor:function(){var colors=["","",""];colors.forEach(function(color,index){var newColor=Math.floor(256*Math.random()).toString(16);colors[index]=1===newColor.length?"0"+newColor:newColor});var color="0x"+colors.join("");return Number(color)},degToRad:function(degrees){return degrees*(Math.PI/180)},radToDeg:function(radians){return radians*(180/Math.PI)},getRandomFloat:function(min,max){if(min>max)throw"ERROR: getRandomFloat min > max";return Math.random()*(max-min)+min},getRandomInteger:function(min,max){if(min>max)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(max-min+1)+min)},rand:function(min,max){return this.getRandomInteger(min,max)},mixin:function(receiver,donor){for(var prop in donor.prototype)receiver[prop]=donor.prototype[prop]},uptrunc:function(x){return 0>x?Math.floor(x):Math.ceil(x)}};Function.prototype.extend||(Function.prototype.extend=function(oldClass){this.prototype=Object.create(oldClass.prototype),this.prototype.constructor=oldClass});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BaseActor=function(){function BaseActor(position,angle,positionZ,diameter){if(_classCallCheck(this,BaseActor),position&&position instanceof THREE.Vector2!=!0)throw"ERROR: invalid position vector for actor";this.collisionCells=[],this.position=position||new THREE.Vector2(0,0),this.positionZ=positionZ||10,this.diameter=diameter||0,this.angle=angle||0,this.thrust=0,this.counter=0,this.actorsCollidingWith=[],this.physicsProperties={friction:0,acceleration:0,deceleration:0}}return _createClass(BaseActor,[{key:"getPVAS",value:function(){return[this.position,this.angle]}},{key:"update",value:function(){this.fixAngleRollover(),this.controls&&this.controls.update(),this.customUpdate(),this.physics&&(this.handleCollisions(),this.physics.update(this.position,this.angle,this.thrust),this.position=this.physics.position,this.angle=this.physics.angle),this.mesh&&this.mesh.update(this.position,this.angle,this.positionZ),this.light&&this.light.update(this.position,this.angle)}},{key:"handleCollisions",value:function(){for(var i=0;i<this.actorsCollidingWith;i++){this.actorsCollidingWith[i]}this.actorsCollidingWith=[]}},{key:"customUpdate",value:function(){}},{key:"addToScene",value:function(scene){this.mesh&&scene.add(this.mesh.get()),this.light&&scene.add(this.light.get())}},{key:"removeFromScene",value:function(scene){this.mesh&&scene.remove(this.mesh.get()),this.light&&(scene.remove(this.light.get()),delete this.light.get())}},{key:"fixAngleRollover",value:function(){this.angle>360&&(this.angle-=360),this.angle<0&&(this.angle+=360)}},{key:"updatePhysicsProperties",value:function(physicsProperties){if(physicsProperties instanceof"object"!=!0)throw"ERROR: Actor's physicsProperties must be object";this.physicsProperties=physicsProperties,this.physics&&this.physics.updateProperties(physicsProperties)}}]),BaseActor}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MapLightActor=function(_BaseActor){function MapLightActor(){_classCallCheck(this,MapLightActor);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(MapLightActor).call(this,null,null,10,50));return _this.diameter=50,_this.light=_this.createLight(),_this}return _inherits(MapLightActor,_BaseActor),_createClass(MapLightActor,[{key:"createLight",value:function(){return new MapPointLight(this,this.diameter,16777215)}},{key:"setVisible",value:function(visible){this.light.light.visible=visible}}]),MapLightActor}(BaseActor),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MookActor=function(_BaseActor){function MookActor(position){_classCallCheck(this,MookActor);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(MookActor).call(this,position,0));return _this.mesh=_this.createMesh(),_this.physicsProperties={friction:.01,acceleration:.05,deceleration:.04},_this.physics=_this.createPhysics(),_this.diameter=2,_this.turning=0,_this.thrustSetting=0,_this}return _inherits(MookActor,_BaseActor),_createClass(MookActor,[{key:"customUpdate",value:function(){this.actorLogic()}},{key:"createMesh",value:function(){return new ShipMesh(this,this.diameter,Utils.makeRandomColor())}},{key:"createPhysics",value:function(){return new BasePhysics(this)}},{key:"actorLogic",value:function(){switch(this.turning){case-1:this.angle--;break;case-2:this.angle-=3;break;case 1:this.angle++;break;case 2:this.angle+=3}if(this.thrust=this.thrustSetting,100===Utils.rand(0,100)&&(this.turning=Utils.rand(-2,2)),Utils.rand(0,100)>97){var thrustRand=Utils.rand(0,100);thrustRand>20?this.thrustSetting=1:2>=thrustRand?this.thrustSetting=-1:this.thrustSetting=0}}}]),MookActor}(BaseActor),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),PlayerActor=function(_BaseActor){function PlayerActor(controlsHandler){_classCallCheck(this,PlayerActor);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(PlayerActor).call(this,null,null,30,30));return _this.controlsHandler=controlsHandler,_this.mesh=_this.createMesh(),_this.light=_this.createLight(),_this.controls=_this.createControls(),_this.physicsProperties={friction:.01,acceleration:.1,deceleration:.04},_this.physics=_this.createPhysics(),_this.diameter=2,_this}return _inherits(PlayerActor,_BaseActor),_createClass(PlayerActor,[{key:"createMesh",value:function(){return new ShipMesh(this,7,16711680)}},{key:"createControls",value:function(){return new OctaControls(this,this.controlsHandler)}},{key:"createLight",value:function(){return new PointLight(this,120,6706466)}},{key:"createPhysics",value:function(){return new BasePhysics(this)}},{key:"customUpdate",value:function(){}}]),PlayerActor}(BaseActor),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),OctaControls=function(){function OctaControls(actor,controlsHandler){_classCallCheck(this,OctaControls),this.controlsHandler=controlsHandler,this.actor=actor}return _createClass(OctaControls,[{key:"update",value:function(){this.actor.thrust=0,this.controlsHandler.moveState.w&&(this.actor.thrust=1),this.controlsHandler.moveState.s&&(this.actor.thrust=-1),this.controlsHandler.moveState.a&&(this.actor.angle-=3),this.controlsHandler.moveState.d&&(this.actor.angle+=3)}}]),OctaControls}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BaseLight=function(){function BaseLight(actor){_classCallCheck(this,BaseLight),this.actor=actor,this.followActor=!0,this.zOffset=0}return _createClass(BaseLight,[{key:"update",value:function(){this.followActor&&this.light&&(this.light.position.x=this.actor.position.x,this.light.position.y=this.actor.position.y,this.light.position.z=this.actor.positionZ+this.zOffset)}},{key:"createLight",value:function(){return null}},{key:"get",value:function(){return this.light}}]),BaseLight}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MapPointLight=function(_BaseLight){function MapPointLight(actor,distance,color){_classCallCheck(this,MapPointLight);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(MapPointLight).call(this,actor));return _this._distance=distance,_this._color=color,_this.inFrustum=!1,_this.zOffset=20,_this.light=_this.createLight(),_this}return _inherits(MapPointLight,_BaseLight),_createClass(MapPointLight,[{key:"createLight",value:function(){var light=new THREE.PointLight(this._color);return light.distance=this._distance,light}},{key:"reset",value:function(){console.log("MPL reset")}}]),MapPointLight}(BaseLight),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),PointLight=function(_BaseLight){function PointLight(actor,distance,color){_classCallCheck(this,PointLight);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(PointLight).call(this,actor));return _this._distance=distance,_this._color=color,_this.zOffset=20,_this.light=_this.createLight(),_this}return _inherits(PointLight,_BaseLight),_createClass(PointLight,[{key:"createLight",value:function(){var light=new THREE.PointLight(this._color);return light.position.z=20,light.distance=this._distance,light.castShadow=!1,light.shadowCameraNear=1,light.shadowCameraFar=200,light.shadowDarkness=.5,light.shadowMapWidth=2048,light.shadowMapHeight=1024,light.shadowBias=.01,light}}]),PointLight}(BaseLight),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Manager=function(){function Manager(scene,collisionClass){_classCallCheck(this,Manager),this._scene=scene,this._objectPool=[],this.collisionClass=collisionClass,this.collisionMap={},this.GRID_BOX_SIDE_LENGTH=10,this.BOXES_PER_GRID_EDGE=1e3,this.BOXES_PER_GRID_EDGE=Math.floor(this.BOXES_PER_GRID_EDGE),this.HALF_EDGE=this.BOXES_PER_GRID_EDGE/2}return _createClass(Manager,[{key:"update",value:function(){var _this=this;this.collisionClass&&this._objectPool.forEach(function(object){_this.collisionGridUpdate(_this.collisionMap,object)}),this._objectPool.forEach(function(object){object.update()})}},{key:"add",value:function(actor){this._objectPool.push(actor),actor.addToScene(this._scene)}},{key:"getActiveActors",value:function(){return this._objectPool}},{key:"makeActorPositionIndices",value:function(actor){var indices=[],xPlusPart=Math.floor((actor.position.x+actor.diameter)/this.GRID_BOX_SIDE_LENGTH)+1+this.HALF_EDGE,xMinusPart=Math.floor((actor.position.x-actor.diameter)/this.GRID_BOX_SIDE_LENGTH)+1+this.HALF_EDGE,yPlusPart=(Math.floor((actor.position.y+actor.diameter)/this.GRID_BOX_SIDE_LENGTH)+1+this.HALF_EDGE)*this.BOXES_PER_GRID_EDGE,yMinusPart=(Math.floor((actor.position.y-actor.diameter)/this.GRID_BOX_SIDE_LENGTH)+1+this.HALF_EDGE)*this.BOXES_PER_GRID_EDGE;return indices.push(xMinusPart+yMinusPart),indices.push(xMinusPart+yPlusPart),indices.push(xPlusPart+yMinusPart),indices.push(xPlusPart+yPlusPart),indices}},{key:"addToCollisionGrid",value:function(collisionMap,indices,actor){for(var actorListAtCollisionMap,j=0;4>j;j++)actorListAtCollisionMap=collisionMap[indices[j]],actorListAtCollisionMap?actorListAtCollisionMap.indexOf(actor)<0&&(actorListAtCollisionMap.push(actor),actor.collisionCells.push(indices[j])):(collisionMap[indices[j]]=[actor],actor.collisionCells.push(indices[j]))}},{key:"cleanCollisionGrid",value:function(collisionMap,indices,actor){for(var i=0;i<actor.collisionCells.length;i++)indices.indexOf(actor.collisionCells[i])<0&&(collisionMap[actor.collisionCells[i]].splice(collisionMap[actor.collisionCells[i]].indexOf(actor),1),0===collisionMap[actor.collisionCells[i]].length&&delete collisionMap[actor.collisionCells[i]],actor.collisionCells.splice(i,1))}},{key:"collisionGridUpdate",value:function(collisionMap,actor){var indices=this.makeActorPositionIndices(actor);this.addToCollisionGrid(collisionMap,indices,actor),this.cleanCollisionGrid(collisionMap,indices,actor)}}]),Manager}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_get=function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)},MapLightManager=function(_Manager){function MapLightManager(scene,camera){_classCallCheck(this,MapLightManager);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(MapLightManager).call(this,scene));
return _this._camera=camera,_this._cameraFrustum=new THREE.Frustum,_this._frustumTestSphere=new THREE.Sphere,_this}return _inherits(MapLightManager,_Manager),_createClass(MapLightManager,[{key:"updateCameraFrustum",value:function(){this._cameraFrustum.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this._camera.projectionMatrix,this._camera.matrixWorldInverse))}},{key:"update",value:function(){var _this2=this;_get(Object.getPrototypeOf(MapLightManager.prototype),"update",this).call(this),this.updateCameraFrustum(),this._objectPool.forEach(function(lightActor){_this2._frustumTestSphere.center=lightActor.position,_this2._frustumTestSphere.radius=lightActor.diameter;var lightActorVisibleBefore=lightActor.visible;lightActor.visible=_this2._cameraFrustum.intersectsSphere(_this2._frustumTestSphere),lightActorVisibleBefore&&!lightActor.visible&&lightActor.setVisible(!1),!lightActorVisibleBefore&&lightActor.visible&&lightActor.setVisible(!0)})}}]),MapLightManager}(Manager);MasterManager.prototype.add=function(manager,name){manager.collisionMap=this.collisionMap,this.managers[name]=manager},MasterManager.prototype.get=function(name){return this.managers[name]},MasterManager.prototype.update=function(){var _this=this;Object.keys(this.managers).forEach(function(managerName){_this.managers[managerName].update()}),this.collision.update()};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BaseMesh=function(){function BaseMesh(actor){_classCallCheck(this,BaseMesh),this.actor=actor,this.followActor=!0,this.meshRotationVector=new THREE.Vector3(0,0,1),this.angleOffset=0}return _createClass(BaseMesh,[{key:"update",value:function(position,deltaAngle,positionZ){this.followActor&&this.mesh&&(this.mesh.position.x=position.x,this.mesh.position.y=position.y,this.mesh.position.z=positionZ,this.mesh.rotation.z=Utils.degToRad(-this.actor.angle+this.angleOffset))}},{key:"createMesh",value:function(){return null}},{key:"get",value:function(){return this.mesh}}]),BaseMesh}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ShipMesh=function(_BaseMesh){function ShipMesh(actor,radius,color){_classCallCheck(this,ShipMesh);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(ShipMesh).call(this,actor));return _this.radius=radius,_this.color=color,_this.angleOffset=180,_this.mesh=_this.createMesh(),_this}return _inherits(ShipMesh,_BaseMesh),_createClass(ShipMesh,[{key:"createMesh",value:function(){ModelStore.get("ship").material.color.setHex(Utils.makeRandomColor());var mesh=new THREE.Mesh(ModelStore.get("ship").geometry,ModelStore.get("ship").material);return mesh}}]),ShipMesh}(BaseMesh),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),SphereMesh=function(_BaseMesh){function SphereMesh(actor,radius,color){_classCallCheck(this,SphereMesh);var _this=_possibleConstructorReturn(this,Object.getPrototypeOf(SphereMesh).call(this,actor));return _this.radius=radius,_this.color=color,_this.mesh=_this.createMesh(),_this}return _inherits(SphereMesh,_BaseMesh),_createClass(SphereMesh,[{key:"createMesh",value:function(){var radius=this.radius||1,segments=8,rings=8,sphereMaterial=new THREE.MeshLambertMaterial({color:this.color||16777215}),mesh=new THREE.Mesh(new THREE.SphereGeometry(radius,segments,rings),sphereMaterial);return mesh}}]),SphereMesh}(BaseMesh),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BasePhysics=function(){function BasePhysics(actor,physicsProperties){_classCallCheck(this,BasePhysics),this.actor=actor,this.angle=actor.angle,this.position=actor.position,this.speed=0,this.friction=0,this.acceleration=0,this.deceleration=0,this.velocityVector=new THREE.Vector2(0,0),this.updateProperties(),this.clock=0}return _createClass(BasePhysics,[{key:"calculatePositionVector",value:function(){this.position.add(this.velocityVector)}},{key:"setVelocity",value:function(angle,thrust){this.velocityVector.x=(this.velocityVector.x+Math.sin(Utils.degToRad(angle))*thrust*this.acceleration)*(1-this.deceleration),this.velocityVector.y=(this.velocityVector.y+Math.cos(Utils.degToRad(angle))*thrust*this.acceleration)*(1-this.deceleration);var length=this.velocityVector.length();this.velocityVector.setLength(length>this.friction?length-this.friction:0)}},{key:"updateProperties",value:function(){var _this=this;Object.keys(this.actor.physicsProperties).forEach(function(property){_this[property]=_this.actor.physicsProperties[property]})}},{key:"update",value:function(position,angle,thrust){this.angle=angle,this.position=position,this.setVelocity(angle,thrust),this.calculatePositionVector(),this.clock++}}]),BasePhysics}();Collisions.prototype.makeCollisionClassMap=function(){return{object:["object","explosion","ship","level"],explosion:["ship"],ship:["ship","level"]}},Collisions.prototype.update=function(){this.coarseCheck(),this.counter++,this.counter>60&&(console.log("coarse collisions:",this.coarseCheckCount),this.counter=0,this.fineCheckCount=0,this.coarseCheckCount=0)},Collisions.prototype.coarseCheck=function(){for(var actorA,actorB,collisionCell,collisionMap=this.masterManager.collisionMap,collisionIndices=Object.keys(collisionMap),c=0;c<collisionIndices.length;c++)if(collisionCell=collisionMap[collisionIndices[c]],collisionCell&&collisionCell.length>1){0===this.counter&&this.coarseCheckCount++;for(var i=0;i<=collisionCell.length;i++)for(var j=i+1;j<collisionCell.length;j++)actorA=collisionCell[i],actorB=collisionCell[j],(actorA.position.x+actorA.diameter>actorB.position.x-actorB.diameter||actorA.position.x-actorA.diameter<actorB.position.x+actorB.diameter||actorA.position.y+actorA.diameter>actorB.position.y-actorB.diameter||actorA.position.y-actorA.diameter<actorB.position.y+actorB.diameter)&&actorA.actorsCollidingWith.indexOf(actorB)<0&&actorA.actorsCollidingWith.push(actorB)}};var ModelList={models:["/models/ship.json"]},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ModelLoader=function(){function ModelLoader(modelPaths){if(_classCallCheck(this,ModelLoader),!modelPaths)throw"ERROR: No model paths have been specified for the loader!";this.modelPaths=modelPaths,this.batch={},this.loaded=!0,Utils.mixin(this,THREE.EventDispatcher)}return _createClass(ModelLoader,[{key:"loadModels",value:function(){var _this=this;if(!this.loaded)throw"ERROR: ModelLoader is still busy loading previous batch!";this.loaded=!1;var loader=new THREE.JSONLoader;this.modelPaths.forEach(function(modelPath,index){_this.batch[_this._getModelName(modelPath)]={geometry:null,material:null,loaded:!1},loader.load(modelPath,function(geometry,material){var model=_this.batch[_this._getModelName(modelPath)];model.geometry=geometry,model.material=material,model.loaded=!0,_this.checkIfLoaded()&&_this._doneAction()})})}},{key:"checkIfLoaded",value:function(){var result=!0;for(var modelName in this.batch)if(!this.batch[modelName].loaded)return result=!1,!1;return result}},{key:"getBatch",value:function(){return this.batch}},{key:"clearBatch",value:function(){this.batch={}}},{key:"_doneAction",value:function(){this.loaded=!0,this.dispatchEvent({type:"loaded"})}},{key:"_getModelName",value:function(path){var name=path.split(".")[0].split("/").pop();if(!name)throw"ERROR: Bad model path: "+path;return name}}]),ModelLoader}(),ModelStore={_materials:{},_geometries:{},get:function(name){return{geometry:this._geometries[name],material:this._materials[name]}},loadBatch:function(batch){console.log(this),Object.keys(batch).forEach(function(modelName){this._addGeometry(modelName,batch[modelName].geometry),this._addMaterial(modelName,batch[modelName].material)}.bind(this))},_addGeometry:function(name,geometry){if(geometry instanceof THREE.Geometry!=!0)throw"ERROR - geometry not instance of THREE.Geometry";this._geometries[name]=geometry},_addMaterial:function(name,material){if(!material)throw"ERROR - no material specified";this._materials[name]=material instanceof Array?material[0]:material}},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BaseObjectPool=function(){function BaseObjectPool(poolSize){_classCallCheck(this,BaseObjectPool),this.usedPool=[],this.emptyPool=[],this.poolSize=poolSize||10,this._initPool()}return _createClass(BaseObjectPool,[{key:"create",value:function(newObjectParams){var newlyCreatedObject=this._fetchNextEmpty();return this.resetObject(newlyCreatedObject),Object.assign(newlyCreatedObject,newObjectParams),this.usedPool.unshift(newlyCreatedObject),newlyCreatedObject}},{key:"destroy",value:function(object){var result=this._moveObjectToEmptyPool(object);return this.resetObject(object),result}},{key:"constructNewObject",value:function(){return{reset:function(){console.warn("Default object reset function is not implemented")}}}},{key:"resetObject",value:function(object){if(!object.reset)throw"No reset function implemented for object "+object;object.reset()}},{key:"iterate",value:function(fn){this.usedPool.forEach(fn)}},{key:"_initObject",value:function(){var object=this.constructNewObject();return this.resetObject(object),object}},{key:"_initPool",value:function(){for(var i=0;i<this.poolSize;i++){var object=this._initObject();this.emptyPool.push(object)}}},{key:"fetchNextEmpty",value:function(){var poolToTakeFrom=this.emptyPool.length>0?this.emptyPool:this.usedPool;return poolToTakeFrom.pop()}},{key:"moveObjectToEmptyPool",value:function(object){var index=this.usedPool.indexOf(object);return index>=0?(this.usedPool.splice(index,1),this.emptyPool.push(object),!0):!1}}]),BaseObjectPool}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),LightPool=function(_BaseObjectPool){function LightPool(){return _classCallCheck(this,LightPool),_possibleConstructorReturn(this,Object.getPrototypeOf(LightPool).apply(this,arguments))}return _inherits(LightPool,_BaseObjectPool),_createClass(LightPool,[{key:"constructNewObject",value:function(){return new MapPointLight(null,0,16777215)}}]),LightPool}(BaseObjectPool),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),GameScene=function(){function GameScene(core,scene){_classCallCheck(this,GameScene),this.core=core,this.scene=scene,this.lightCounter=0;this.sphereGeometry=new THREE.SphereGeometry(1,32,16,0,Math.PI)}return _createClass(GameScene,[{key:"makeSphere",value:function(sphereMaterial,_radius){return new THREE.Mesh(this.sphereGeometry,sphereMaterial)}},{key:"makeWalls",value:function(){for(var wall,walls=[],material=new THREE.MeshLambertMaterial({color:16777215}),wallGeometry=new THREE.BoxGeometry(10,100,5,20,20),i=0;100>i;i++)wall=new THREE.Mesh(wallGeometry,material),wall.position.x=Utils.rand(-300,300),wall.position.y=Utils.rand(-300,300),wall.position.z=0,wall.rotateZ(Utils.degToRad(Utils.rand(0,360))),walls.push(wall);var combine=new THREE.Geometry;return walls.forEach(function(w){w.updateMatrix(),combine.merge(w.geometry,w.matrix)}),new THREE.Mesh(combine,material)}},{key:"make",value:function(){for(var j=0;5>j;j++){var light=new MapLightActor;light.position.x=1e3*Math.random()-500,light.position.y=1e3*Math.random()-500,this.core.masterManager.get("light").add(light)}for(var i=0;2e3>i;i++){var mook=new MookActor(new THREE.Vector2(Utils.rand(-100,100),Utils.rand(-100,100)));mook.angle=Utils.rand(0,360),this.core.masterManager.get("ship").add(mook)}var combine=new THREE.Geometry,geometry=new THREE.PlaneGeometry(1e3,1e3,200,200),material=new THREE.MeshLambertMaterial({color:16777215}),floor=new THREE.Mesh(geometry,material);floor.updateMatrix(),combine.merge(floor.geometry,floor.matrix);var walls=this.makeWalls();combine.merge(walls.geometry,walls.matrix);var combinedObject=new THREE.Mesh(combine,material);combinedObject.matrixAutoUpdate=!1,combinedObject.updateMatrix(),this.scene.add(combinedObject);var testLight=new THREE.PointLight(5570560,1,100);testLight.position.set(50,50,50),this.scene.add(testLight),console.log(testLight)}},{key:"update",value:function(delta){}}]),GameScene}();
//# sourceMappingURL=sourceMap.map