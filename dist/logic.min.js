"use strict";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function ActorFactory(a){var b;this.actorDependencies=a,this.actorMap=(b={},_defineProperty(b,ActorFactory.SHIP,ShipActor),_defineProperty(b,ActorFactory.MOOK,MookActor),_defineProperty(b,ActorFactory.EXPLOSION,ExplosionActor),_defineProperty(b,ActorFactory.WALL,WallActor),_defineProperty(b,ActorFactory.PROJECTILE,ProjectileActor),b)}function Core(a){this.makeMainComponents(a),this.startGameLoop(),this.scene.fillScene(),this.initFpsCounter()}function GameScene(a){if(Object.assign(this,a),!this.world)throw new Error("No world specified for Logic GameScene");if(!this.actorManager)throw new Error("No actorManager specified for Logic GameScene");this.timer=0}function RenderBus(a){if(!a)throw new Error("No worker object specified for Logic Render Bus");this.worker=a,this.inputState={},this.worker.onmessage=this.handleMessage.bind(this)}function GameWorld(a){p2.World.apply(this,arguments),this.transferArray=new Float32Array(5*Constants.STORAGE_SIZE),a=a||{},this.gravity=[0,0],this.islandSplit=!1,Object.assign(this,a),this.on("impact",this.onCollision.bind(this))}function BaseActor(a){if(Object.assign(this,a),this.body=this.createBody(),!this.body)throw new Error("No body defined for Logic Actor!");this.body.position=[this.positionX||0,this.positionY||0],this.body.angle=this.angle||0,this.body.actor=this,this.body.velocity=MathUtils.angleToVector(this.angle,this.velocity||0),this.acceleration=0,this.turnSpeed=0,this.thrust=0,this.rotationForce=0,this.hp=1/0,this.damage=0,this.collisionDamage=1,this.armor=0,this.collisionArmor=1/0,this.timeout=1/0,this.timer=0}function ExplosionActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.timeout=1}function MookActor(a){a=a||[],BaseActor.apply(this,arguments),this.acceleration=200,this.turnSpeed=.8,this.thrust=0,this.rotationForce=0}function ProjectileActor(a){a=a||[],BaseActor.apply(this,arguments),this.hp=1,this.collisionArmor=0}function ShipActor(a){a=a||[],BaseActor.apply(this,arguments),this.acceleration=1e3,this.backwardAccelerationRatio=.7,this.horizontalAccelerationRatio=.7,this.turnSpeed=4,this.stepAngle=Utils.radToDeg(this.turnSpeed/Constants.LOGIC_REFRESH_RATE),this.thrust=0,this.rotationForce=0,this.lastInputStateX=0,this.lastInputStateY=0}function WallActor(a){a=a||[],BaseActor.apply(this,arguments)}function BaseBody(a){p2.Body.apply(this,arguments),this.actorId=null,a.position=a.position||[0,0],a.angle=Utils.degToRad(a.angle||0),a.shape=a.shape||this.createShape(),Object.assign(this,a),this.initShape()}function ExplosionBody(a){Object.assign(this,a),BaseBody.apply(this,arguments)}function ExplosionBody(a){Object.assign(this,a),BaseBody.apply(this,arguments)}function BaseWeapon(a){}function ActorManager(a){if(a=a||{},this.core=null,this.storage=Object.create(null),this.world=null,this.factory=a.factory||new ActorFactory,this.currentId=1,this.playerActors=[],Object.assign(this,a),!this.world)throw new Error("No world for Logic ActorManager!")}function ActorStorage(){this.SIZE=Constants.STORAGE_SIZE,this.storage=[],this.currentId=0,this.holes=[]}var Utils={makeRandomColor:function(){var a=["","",""];a.forEach(function(b,c){var d=Math.floor(256*Math.random()).toString(16);a[c]=1===d.length?"0"+d:d});var b="0x"+a.join("");return Number(b)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},getRandomFloat:function(a,b){if(a>b)throw"ERROR: getRandomFloat min > max";return Math.random()*(b-a)+a},getRandomInteger:function(a,b){if(a>b)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(b-a+1)+a)},rand:function(a,b){return this.getRandomInteger(a,b)},mixin:function(a,b){for(var c in b.prototype)a[c]=b.prototype[c]},uptrunc:function(a){return 0>a?Math.floor(a):Math.ceil(a)}};Function.prototype.extend||(Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype),this.prototype.constructor=a});var Constants={SHOW_FPS:!1,LOGIC_REFRESH_RATE:60,COLLISION_GROUPS:{SHIP:Math.pow(2,0),ENEMY:Math.pow(2,1),SHIPPROJECTILE:Math.pow(2,2),ENEMYPROJECTILE:Math.pow(2,3),EXPLOSION:Math.pow(2,4),TERRAIN:Math.pow(2,10)},STORAGE_SIZE:1e3};ActorFactory.SHIP=1,ActorFactory.MOOK=2,ActorFactory.EXPLOSION=3,ActorFactory.WALL=4,ActorFactory.PROJECTILE=100,ActorFactory.prototype.create=function(a){if(!this.actorMap[a.classId])throw new Error("Cannot create actor. Bad configuration!".config);return new this.actorMap[a.classId](a,this.actorDependencies)},Core.prototype.makeMainComponents=function(a){this.world=new GameWorld,this.actorManager=new ActorManager({world:this.world,core:this}),this.renderBus=new RenderBus(a),this.scene=new GameScene({world:this.world,actorManager:this.actorManager})},Core.prototype.initFpsCounter=function(){var a=this;this.logicTicks=0,Constants.SHOW_FPS&&setInterval(function(){console.log("logicTicks: ",a.logicTicks),a.logicTicks=0},1e3)},Core.prototype.createWorld=function(){return new p2.World({gravity:[0,0],islandSplit:!1})},Core.prototype.processGameLogic=function(){this.actorManager.update(this.renderBus.inputState),this.world.step(1/Constants.LOGIC_REFRESH_RATE),this.renderBus.postMessage("updateActors",this.world.makeUpdateData()),this.logicTicks++,this.scene.update()},Core.prototype.startGameLoop=function(){var a=new THREEx.PhysicsLoop(Constants.LOGIC_REFRESH_RATE);a.add(this.processGameLogic.bind(this)),a.start()},GameScene.prototype.fillScene=function(){for(var a=0;100>a;a++)this.actorManager.addNew({classId:ActorFactory.MOOK,positionX:Utils.rand(-150,150),positionY:Utils.rand(-150,150),angle:Utils.rand(0,360)});this.actorManager.addNew({classId:ActorFactory.WALL,positionX:0,positionY:-200,angle:0}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:0,positionY:200,angle:0}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:200,positionY:0,angle:Math.PI/2}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:-200,positionY:0,angle:Math.PI/2});var b=this.actorManager.addNew({classId:ActorFactory.SHIP,positionX:0,positionY:0,angle:0});this.actorManager.setPlayerActor(b),console.log("scene complete")},GameScene.prototype.update=function(){this.timer++;for(var a=0;10>a;a++)this.actorManager.addNew({classId:ActorFactory.PROJECTILE,positionX:0,positionY:0,angle:Utils.rand(0,360),velocity:Utils.rand(220,280)})};var MathUtils={angleToVector:function(a,b){return b=b||0,[-1*Math.sin(a)*b,Math.cos(a)*b]},vectorAngleToPoint:function(a,b,c,d){var e=Math.atan2(c,a)-Math.atan2(d,b);return e=360*e/(2*Math.PI),0>e&&(e+=360),e},angleBetweenPoints:function(a,b,c,d){var e=d-b,f=c-a,g=Math.atan2(f,e);return g*=180/Math.PI,0>g&&(g=360+g),g}};RenderBus.prototype.postMessage=function(a,b){b.type=a,this.worker.postMessage(b)},RenderBus.prototype.handleMessage=function(a){switch(a.data.type){case"inputState":this.inputState=a.data}},GameWorld.extend(p2.World),GameWorld.prototype.makeUpdateData=function(){for(var a=[],b=this.transferArray,c=0;c<this.bodies.length;c++){var d=this.bodies[c];b[5*c]=d.actorId,b[5*c+1]=d.dead?-1:d.classId,b[5*c+2]=d.position[0],b[5*c+3]=d.position[1],b[5*c+4]=d.angle,d.dead&&(a.push(d.actorId),d.onDeath(),this.removeBody(d)),d.update()}return{length:this.bodies.length,transferArray:this.transferArray,deadActors:a}},GameWorld.prototype.onCollision=function(a){a.bodyA.onCollision(a.bodyB),a.bodyB.onCollision(a.bodyA)},BaseActor.prototype.createBody=function(){return null},BaseActor.prototype.update=function(){this.timer++,this.timer>this.timeout&&this.onDeath(),this.customUpdate()},BaseActor.prototype.onCollision=function(a){this.hp-=Math.max((a?a.collisionDamage:0)-this.collisionArmor,0),this.hp<=0&&this.onDeath()},BaseActor.prototype.remove=function(a){this.manager.removeActorAt(a)},BaseActor.prototype.customUpdate=function(){},BaseActor.prototype.playerUpdate=function(){},BaseActor.prototype.onDeath=function(){this.body.dead=!0},ExplosionActor.extend(BaseActor),ExplosionActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Circle({radius:this.radius,collisionGroup:Constants.COLLISION_GROUPS.EXPLOSION,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.ENEMYPROJECTILE}),collisionResponse:!1,actor:this,mass:.01})},ExplosionActor.prototype.onCollision=function(a,b){},MookActor.extend(BaseActor),MookActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-5,3],[0,0],[5,3],[0,4]],collisionGroup:Constants.COLLISION_GROUPS.ENEMY,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN|Constants.COLLISION_GROUPS.EXPLOSION}),actor:this,mass:2,damping:.75,angularDamping:0,inertia:10})},MookActor.prototype.customUpdate=function(){this.actorLogic(),0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0},MookActor.prototype.actorLogic=function(){if(100===Utils.rand(0,100)&&(this.rotationForce=Utils.rand(-2,2)),Utils.rand(0,100)>97){var a=Utils.rand(0,100);a>20?this.thrust=1:2>=a?this.thrust=-1:this.thrust=0}},ProjectileActor.extend(BaseActor),ProjectileActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Circle({radius:3,collisionGroup:Constants.COLLISION_GROUPS.ENEMYPROJECTILE,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN}),actor:this,mass:1e-4})},ProjectileActor.prototype.onDeath=function(){this.body.dead=!0;var a=new ExplosionBody({position:this.body.position,radius:20,lifetime:1,mass:.001});this.world.addBody(a)},ShipActor.extend(BaseActor),ShipActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-15,8],[-6,-2],[6,-2],[15,8],[15,14],[0,20],[-15,14]],collisionGroup:Constants.COLLISION_GROUPS.SHIP,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN|Constants.COLLISION_GROUPS.EXPLOSION}),actor:this,mass:4,damping:.75,angularDamping:0,inertia:10})},ShipActor.prototype.customUpdate=function(){0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0,0!==this.horizontalThrust&&this.body.applyForceLocal([this.horizontalThrust*this.acceleration,0])},ShipActor.prototype.playerUpdate=function(a){this.applyThrust(a),this.applyRotation(a)},ShipActor.prototype.applyRotation=function(a){this.rotationForce=0;var b=MathUtils.angleToVector(this.body.angle,1),c=MathUtils.vectorAngleToPoint(b[0],a.lookX-this.body.position[0],b[1],a.lookY-this.body.position[1]);180>c&&c>0&&(this.rotationForce=-1*Math.min(c/this.stepAngle,1)),c>=180&&360>c&&(this.rotationForce=Math.min((360-c)/this.stepAngle,1)),a.q&&(this.rotationForce=1),a.e&&(this.rotationForce=-1),this.lastInputStateX=a.lookX,this.lastInputStateY=a.lookY},ShipActor.prototype.applyThrust=function(a){this.thrust=0,this.horizontalThrust=0,a.a&&(this.horizontalThrust=-1*this.horizontalAccelerationRatio),a.d&&(this.horizontalThrust=1*this.horizontalAccelerationRatio),a.w&&(this.thrust=1),a.s&&(this.thrust=-1*this.backwardAccelerationRatio)},WallActor.extend(BaseActor),WallActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Box({height:5,width:400,collisionGroup:Constants.COLLISION_GROUPS.TERRAIN,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMYPROJECTILE}),actor:this,mass:0})},BaseBody.extend(p2.Body),BaseBody.prototype.createShape=function(){return new p2.Box({height:5,width:5})},BaseBody.prototype.initShape=function(){this.addShape(this.shape)},BaseBody.prototype.onDeath=function(){this.actor.remove(this.actorId)},BaseBody.prototype.onCollision=function(a){this.actor.onCollision(a.actor)},BaseBody.prototype.update=function(){},ExplosionBody.extend(BaseBody),ExplosionBody.prototype.createShape=function(){return console.log(this.radius),new p2.Circle({radius:this.radius,collisionGroup:Constants.COLLISION_GROUPS.EXPLOSION,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.ENEMYPROJECTILE})},ExplosionBody.prototype.onDeath=function(){this.actor.remove()},ExplosionBody.extend(BaseBody),ExplosionBody.prototype.createShape=function(){return new p2.Circle({radius:this.radius,collisionGroup:Constants.COLLISION_GROUPS.EXPLOSION,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.ENEMYPROJECTILE})},ExplosionBody.prototype.onDeath=function(){},ExplosionBody.prototype.onCollision=function(a){},ExplosionBody.prototype.update=function(){this.dead=!0},BaseWeapon.prototype.shoot=function(){},ActorManager.prototype.addNew=function(a){if(Object.keys(this.storage).length>=Constants.STORAGE_SIZE)return void console.warn("Actor manager storage is full! Cannot create new Actor!");var b=this.factory.create(a);return b.manager=this,b.world=this.world,b.body.actorId=this.currentId,b.body.classId=a.classId,this.storage[this.currentId]=b,this.currentId++,this.world.addBody(b.body),b},ActorManager.prototype.update=function(a){this.playerActors.forEach(function(b){this.storage[b].playerUpdate(a)}.bind(this));for(var b in this.storage)this.storage[b].update()},ActorManager.prototype.setPlayerActor=function(a){this.playerActors.push(a.body.actorId),this.core.renderBus.postMessage("attachCamera",{actorId:a.body.actorId})},ActorManager.prototype.removeActorAt=function(a){delete this.storage[a]},ActorStorage.prototype.put=function(a){var b=void 0;return this.holes.length>0?b=this.holes.shift():(b=this.currentId,this.currentId++),this.storage[b]=a,b},ActorStorage.prototype.getAt=function(a){return this.storage[a]},ActorStorage.prototype.removeAt=function(a){delete this.storage[a],this.holes.push(a)};
//# sourceMappingURL=logic.min.map