"use strict";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function ActorFactory(a){var b;this.actorDependencies=a,this.actorMap=(b={},_defineProperty(b,ActorFactory.SHIP_ACTOR,ShipActor),_defineProperty(b,ActorFactory.MOOK_ACTOR,MookActor),_defineProperty(b,ActorFactory.LIGHT_ACTOR,LightActor),_defineProperty(b,ActorFactory.WALL_ACTOR,WallActor),b)}function Core(a){var b=this;this.world=new GameWorld,this.actorManager=new ActorManager({world:this.world,core:this}),this.renderBus=new RenderBus(a),this.scene=new GameScene({world:this.world,actorManager:this.actorManager}),this.startGameLoop(),this.scene.fillScene(),this.logicTicks=0,setInterval(function(){console.log("logicTicks: ",b.logicTicks),b.logicTicks=0},1e3)}function GameScene(a){if(Object.assign(this,a),!this.world)throw new Error("No world specified for Logic GameScene");if(!this.actorManager)throw new Error("No actorManager specified for Logic GameScene")}function RenderBus(a){if(!a)throw new Error("No worker object specified for Logic Render Bus");this.worker=a,this.inputState={},this.worker.onmessage=this.handleMessage.bind(this)}function GameWorld(a){p2.World.apply(this,arguments),this.transferArray=new Float32Array(2e4),a=a||{},this.gravity=[0,0],this.islandSplit=!1,Object.assign(this,a)}function BaseActor(a){if(this.body=this.createBody(a),!this.body)throw new Error("No body defined for Logic Actor!");this.body.position=[a[1]||0,a[2]||0],this.body.angle=a[3]||0,this.acceleration=0,this.turnSpeed=0,this.thrust=0,this.rotationForce=0}function LightActor(a){a=a||[],BaseActor.apply(this,arguments)}function MookActor(a){a=a||[],BaseActor.apply(this,arguments),this.acceleration=200,this.turnSpeed=.8,this.thrust=0,this.rotationForce=0}function ShipActor(a){a=a||[],BaseActor.apply(this,arguments),this.acceleration=1e4,this.turnSpeed=4,this.thrust=0,this.rotationForce=0}function WallActor(a){a=a||[],BaseActor.apply(this,arguments)}function BaseBody(a){if(p2.Body.apply(this,arguments),!a.actor)throw"ERROR: no actor specified for body!";a.position=a.position||[0,0],a.angle=Utils.degToRad(a.angle||0),a.sizeX=a.sizeX||5,a.sizeY=a.sizeY||5,a.shape=a.shape||new p2.Box({height:a.sizeY,width:a.sizeX}),Object.assign(this,a),this.createShape()}function ActorManager(a){if(a=a||{},this.core=null,this.storage={},this.world=null,this.factory=a.factory||new ActorFactory,this.currentId=1,this.playerActors=[],Object.assign(this,a),!this.world)throw new Error("No world for Logic ActorManager!")}var Utils={makeRandomColor:function(){var a=["","",""];a.forEach(function(b,c){var d=Math.floor(256*Math.random()).toString(16);a[c]=1===d.length?"0"+d:d});var b="0x"+a.join("");return Number(b)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},getRandomFloat:function(a,b){if(a>b)throw"ERROR: getRandomFloat min > max";return Math.random()*(b-a)+a},getRandomInteger:function(a,b){if(a>b)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(b-a+1)+a)},rand:function(a,b){return this.getRandomInteger(a,b)},mixin:function(a,b){for(var c in b.prototype)a[c]=b.prototype[c]},uptrunc:function(a){return 0>a?Math.floor(a):Math.ceil(a)}};Function.prototype.extend||(Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype),this.prototype.constructor=a}),ActorFactory.SHIP_ACTOR=1,ActorFactory.MOOK_ACTOR=2,ActorFactory.LIGHT_ACTOR=3,ActorFactory.WALL_ACTOR=4,ActorFactory.prototype.create=function(a){return new this.actorMap[a[0]](a,this.actorDependencies)},Core.prototype.createWorld=function(){return new p2.World({gravity:[1,0],islandSplit:!1})},Core.prototype.processGameLogic=function(){this.actorManager.update(this.renderBus.inputState),this.world.step(1/30),this.renderBus.postMessage("updateActors",this.world.makeUpdateData()),this.logicTicks++},Core.prototype.startGameLoop=function(){var a=new THREEx.PhysicsLoop(30);a.add(this.processGameLogic.bind(this)),a.start()},GameScene.prototype.fillScene=function(){for(var a=0;500>a;a++)this.actorManager.addNew([ActorFactory.MOOK_ACTOR,Utils.rand(-150,150),Utils.rand(-150,150),Utils.rand(0,360)]);this.actorManager.addNew([ActorFactory.WALL_ACTOR,0,-200,0]),this.actorManager.addNew([ActorFactory.WALL_ACTOR,0,200,0]),this.actorManager.addNew([ActorFactory.WALL_ACTOR,200,0,Math.PI/2]),this.actorManager.addNew([ActorFactory.WALL_ACTOR,-200,0,Math.PI/2]);var b=this.actorManager.addNew([ActorFactory.SHIP_ACTOR,0,0,0]);this.actorManager.setPlayerActor(b),console.log("scene complete")};var MathUtils={angleToVector:function(a){return[-1*Math.sin(a),Math.cos(a)]},angleBetweenPoints:function(a,b,c,d){var e=Math.atan2(c,a)-Math.atan2(d,b);return e=360*e/(2*Math.PI),0>e&&(e+=360),e}};RenderBus.prototype.postMessage=function(a,b){b.type=a,this.worker.postMessage(b)},RenderBus.prototype.handleMessage=function(a){switch(a.data.type){case"inputState":this.inputState=a.data}},GameWorld.extend(p2.World),GameWorld.prototype.makeUpdateData=function(){for(var a=this.transferArray,b=0;b<this.bodies.length;b++){var c=this.bodies[b];a[5*b]=c.storageId,a[5*b+1]=c.classId,a[5*b+2]=c.position[0],a[5*b+3]=c.position[1],a[5*b+4]=c.angle}return{length:this.bodies.length,transferArray:this.transferArray}},BaseActor.prototype.createBody=function(a){return null},BaseActor.prototype.update=function(){this.customUpdate()},BaseActor.prototype.customUpdate=function(){},BaseActor.prototype.playerUpdate=function(){},LightActor.extend(BaseActor),MookActor.extend(BaseActor),MookActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-5,3],[0,0],[5,3],[0,4]]}),actor:this,mass:1,damping:.75,angularDamping:0,inertia:10})},MookActor.prototype.customUpdate=function(){this.actorLogic(),0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0},MookActor.prototype.actorLogic=function(){if(100===Utils.rand(0,100)&&(this.rotationForce=Utils.rand(-2,2)),Utils.rand(0,100)>97){var a=Utils.rand(0,100);a>20?this.thrust=1:2>=a?this.thrust=-1:this.thrust=0}},ShipActor.extend(BaseActor),ShipActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-15,8],[-6,-2],[6,-2],[15,8],[15,14],[0,20],[-15,14]]}),actor:this,mass:40,damping:.75,angularDamping:0,inertia:10})},ShipActor.prototype.customUpdate=function(){0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0,0!==this.horizontalThrust&&this.body.applyForceLocal([this.horizontalThrust*this.acceleration,0])},ShipActor.prototype.playerUpdate=function(a){this.applyControls(a)},ShipActor.prototype.applyControls=function(a){this.thrust=0,this.horizontalThrust=0,this.rotationForce=0,a.a&&(this.horizontalThrust=-1),a.d&&(this.horizontalThrust=1);var b=MathUtils.angleToVector(this.body.angle,this.body.position[0],this.body.position[1]),c=MathUtils.angleBetweenPoints(b[0],a.lookX-this.body.position[0],b[1],a.lookY-this.body.position[1]);180>=c&&c>4&&(this.rotationForce=-1),c>180&&356>c&&(this.rotationForce=1),a.w&&(this.thrust=1),a.s&&(this.thrust=-1)},WallActor.extend(BaseActor),WallActor.prototype.createBody=function(){return new BaseBody({actor:this,mass:0,sizeX:400,sizeY:2})},BaseBody.extend(p2.Body),BaseBody.prototype.createShape=function(){this.addShape(this.shape)},ActorManager.prototype.addNew=function(a){var b=this.factory.create(a);return b.body.storageId=this.currentId,b.body.classId=a[0],this.storage[this.currentId]=b,this.currentId++,this.world.addBody(b.body),b},ActorManager.prototype.update=function(a){this.playerActors.forEach(function(b){this.storage[b].playerUpdate(a)}.bind(this));for(var b in this.storage)this.storage[b].update()},ActorManager.prototype.setPlayerActor=function(a){this.playerActors.push(a.body.storageId),this.core.renderBus.postMessage("attachCamera",{actorId:a.body.storageId})};
//# sourceMappingURL=logic.min.map