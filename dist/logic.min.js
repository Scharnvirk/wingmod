"use strict";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function ActorFactory(a){var b;this.actorDependencies=a,this.actorMap=(b={},_defineProperty(b,ActorFactory.SHIP,ShipActor),_defineProperty(b,ActorFactory.MOOK,MookActor),_defineProperty(b,ActorFactory.WALL,WallActor),_defineProperty(b,ActorFactory.PLASMAPROJECTILE,ShipPlasmaProjectileActor),_defineProperty(b,ActorFactory.MOLTENPROJECTILE,EnemyMoltenProjectileActor),_defineProperty(b,ActorFactory.LASERPROJECITLE,ShipLaserProjectileActor),b)}function Core(a){this.makeMainComponents(a),this.startGameLoop(),this.scene.fillScene(),this.initFpsCounter()}function GameScene(a){if(Object.assign(this,a),!this.world)throw new Error("No world specified for Logic GameScene");if(!this.actorManager)throw new Error("No actorManager specified for Logic GameScene");this.timer=0}function RenderBus(a){if(!a)throw new Error("No worker object specified for Logic Render Bus");this.worker=a,this.inputState={},this.worker.onmessage=this.handleMessage.bind(this)}function GameWorld(a){p2.World.apply(this,arguments),this.transferArray=new Float32Array(5*Constants.STORAGE_SIZE),a=a||{},this.gravity=[0,0],this.islandSplit=!1,this.applyGravity=!1,this.applySpringForces=!1,this.defaultContactMaterial.friction=0,this.solver.iterations=20,this.solver.tolerance=.02,console.log(this),Object.assign(this,a),this.on("impact",this.onCollision.bind(this))}function BaseActor(a){if(Object.assign(this,a),this.body=this.createBody(),!this.body)throw new Error("No body defined for Logic Actor!");this.body.position=[this.positionX||0,this.positionY||0],this.body.angle=this.angle||0,this.body.actor=this,this.body.velocity=Utils.angleToVector(this.angle,this.velocity||0),this.acceleration=0,this.turnSpeed=0,this.thrust=0,this.rotationForce=0,this.hp=1/0,this.damage=0,this.timeout=1/0,this.timer=0,this.removeOnHit=!1}function EnemyMoltenProjectileActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.hp=1,this.damage=1,this.removeOnHit=!0,this.timeout=1e3}function MookActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.acceleration=100,this.turnSpeed=.8,this.thrust=0,this.rotationForce=0,this.hp=4,this.weaponTimer=0}function ShipActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.acceleration=500,this.backwardAccelerationRatio=.7,this.horizontalAccelerationRatio=.7,this.turnSpeed=4,this.stepAngle=Utils.radToDeg(this.turnSpeed/Constants.LOGIC_REFRESH_RATE),this.thrust=0,this.rotationForce=0,this.lastInputStateX=0,this.lastInputStateY=0,this.daze=0,this.primaryWeaponTimer=0,this.secondaryWeaponTimer=0,this.hp=10}function ShipLaserProjectileActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.hp=1,this.damage=2,this.removeOnHit=!0,this.timeout=60}function ShipPlasmaProjectileActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a),this.hp=1,this.damage=1,this.removeOnHit=!0,this.timeout=60}function WallActor(a){a=a||[],BaseActor.apply(this,arguments),Object.assign(this,a)}function BaseBody(a){p2.Body.apply(this,arguments),this.actorId=null,a.position=a.position||[0,0],a.angle=Utils.degToRad(a.angle||0),a.shape=a.shape||this.createShape(),Object.assign(this,a),this.initShape()}function EnemyExplosionBody(a){Object.assign(this,a),BaseBody.apply(this,arguments)}function ShipExplosionBody(a){Object.assign(this,a),BaseBody.apply(this,arguments)}function ActorManager(a){if(a=a||{},this.core=null,this.storage=Object.create(null),this.world=null,this.factory=a.factory||new ActorFactory,this.currentId=1,this.playerActors=[],Object.assign(this,a),!this.world)throw new Error("No world for Logic ActorManager!")}function ActorStorage(){this.SIZE=Constants.STORAGE_SIZE,this.storage=[],this.currentId=0,this.holes=[]}var Utils={makeRandomColor:function(){var a=["","",""];a.forEach(function(b,c){var d=Math.floor(256*Math.random()).toString(16);a[c]=1===d.length?"0"+d:d});var b="0x"+a.join("");return Number(b)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},getRandomFloat:function(a,b){if(a>b)throw"ERROR: getRandomFloat min > max";return Math.random()*(b-a)+a},getRandomInteger:function(a,b){if(a>b)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(b-a+1)+a)},rand:function(a,b){return this.getRandomInteger(a,b)},mixin:function(a,b){for(var c in b.prototype)a[c]=b.prototype[c]},uptrunc:function(a){return 0>a?Math.floor(a):Math.ceil(a)},angleToVector:function(a,b){return b=b||0,[-1*Math.sin(a)*b,Math.cos(a)*b]},vectorAngleToPoint:function(a,b,c,d){var e=Math.atan2(c,a)-Math.atan2(d,b);return e=360*e/(2*Math.PI),0>e&&(e+=360),e},angleBetweenPoints:function(a,b,c,d){var e=d-b,f=c-a,g=Math.atan2(f,e);return g*=180/Math.PI,0>g&&(g=360+g),g}};Function.prototype.extend||(Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype),this.prototype.constructor=a});var Constants={SHOW_FPS:!1,LOGIC_REFRESH_RATE:60,COLLISION_GROUPS:{SHIP:Math.pow(2,0),ENEMY:Math.pow(2,1),SHIPPROJECTILE:Math.pow(2,2),ENEMYPROJECTILE:Math.pow(2,3),SHIPEXPLOSION:Math.pow(2,4),ENEMYEXPLOSION:Math.pow(2,5),TERRAIN:Math.pow(2,10)},STORAGE_SIZE:1e3};ActorFactory.SHIP=1,ActorFactory.MOOK=2,ActorFactory.WALL=4,ActorFactory.PLASMAPROJECTILE=100,ActorFactory.MOLTENPROJECTILE=101,ActorFactory.LASERPROJECITLE=102,ActorFactory.prototype.create=function(a){if(!this.actorMap[a.classId])throw new Error("Cannot create actor. Bad configuration!".config);return new this.actorMap[a.classId](a,this.actorDependencies)},Core.prototype.makeMainComponents=function(a){this.world=new GameWorld,this.actorManager=new ActorManager({world:this.world,core:this}),this.renderBus=new RenderBus(a),this.scene=new GameScene({world:this.world,actorManager:this.actorManager})},Core.prototype.initFpsCounter=function(){var a=this;this.logicTicks=0,Constants.SHOW_FPS&&setInterval(function(){console.log("logicTicks: ",a.logicTicks),a.logicTicks=0},1e3)},Core.prototype.processGameLogic=function(){this.actorManager.update(this.renderBus.inputState),this.world.step(1/Constants.LOGIC_REFRESH_RATE),this.renderBus.postMessage("updateActors",this.world.makeUpdateData()),this.logicTicks++,this.scene.update()},Core.prototype.startGameLoop=function(){var a=new THREEx.PhysicsLoop(Constants.LOGIC_REFRESH_RATE);a.add(this.processGameLogic.bind(this)),a.start()},GameScene.prototype.fillScene=function(){for(var a=0;50>a;a++)this.actorManager.addNew({classId:ActorFactory.MOOK,positionX:Utils.rand(100,150),positionY:Utils.rand(100,150),angle:Utils.rand(0,360)});this.actorManager.addNew({classId:ActorFactory.WALL,positionX:0,positionY:-200,angle:0}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:0,positionY:200,angle:0}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:200,positionY:0,angle:Math.PI/2}),this.actorManager.addNew({classId:ActorFactory.WALL,positionX:-200,positionY:0,angle:Math.PI/2});var b=this.actorManager.addNew({classId:ActorFactory.SHIP,positionX:0,positionY:0,angle:0});this.actorManager.setPlayerActor(b),console.log("scene complete")},GameScene.prototype.update=function(){this.timer++;for(var a=0;0>a;a++)this.actorManager.addNew({classId:ActorFactory.PROJECTILE,positionX:0,positionY:0,angle:Utils.rand(0,360),velocity:Utils.rand(220,280)})},RenderBus.prototype.postMessage=function(a,b){b.type=a,this.worker.postMessage(b)},RenderBus.prototype.handleMessage=function(a){switch(a.data.type){case"inputState":this.inputState=a.data}},GameWorld.extend(p2.World),GameWorld.prototype.makeUpdateData=function(){for(var a=[],b=this.transferArray,c=0;c<this.bodies.length;c++){var d=this.bodies[c];b[5*c]=d.actorId,b[5*c+1]=d.dead?-1:d.classId,b[5*c+2]=d.position[0],b[5*c+3]=d.position[1],b[5*c+4]=d.angle,d.dead&&(a.push(d.actorId),d.onDeath(),this.removeBody(d)),d.update()}return{length:this.bodies.length,transferArray:this.transferArray,deadActors:a}},GameWorld.prototype.onCollision=function(a){a.bodyA.onCollision(a.bodyB),a.bodyB.onCollision(a.bodyA)},BaseActor.prototype.createBody=function(){return null},BaseActor.prototype.update=function(){this.timer++,this.timer>this.timeout&&this.onDeath(),this.customUpdate()},BaseActor.prototype.onCollision=function(a){a&&(this.hp-=a.damage),(this.hp<=0||this.removeOnHit)&&this.onDeath()},BaseActor.prototype.remove=function(a){this.manager.removeActorAt(a)},BaseActor.prototype.customUpdate=function(){},BaseActor.prototype.playerUpdate=function(){},BaseActor.prototype.onDeath=function(){this.body.dead=!0},EnemyMoltenProjectileActor.extend(BaseActor),EnemyMoltenProjectileActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Circle({radius:1,collisionGroup:Constants.COLLISION_GROUPS.ENEMYPROJECTILE,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN}),actor:this,mass:2,ccdSpeedThreshold:-1,ccdIterations:4})},EnemyMoltenProjectileActor.prototype.onDeath=function(){this.body.dead=!0},MookActor.extend(BaseActor),MookActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-5,3],[0,0],[5,3],[0,4]],collisionGroup:Constants.COLLISION_GROUPS.ENEMY,collisionMask:Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN|Constants.COLLISION_GROUPS.SHIPEXPLOSION}),actor:this,mass:2,damping:.75,angularDamping:0,inertia:10})},MookActor.prototype.customUpdate=function(){this.actorLogic(),0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0,this.processWeapon()},MookActor.prototype.processWeapon=function(){this.weaponTimer>0&&this.weaponTimer--,this.requestShoot&&0===this.weaponTimer&&this.shoot()},MookActor.prototype.actorLogic=function(){if(100===Utils.rand(0,100)&&(this.rotationForce=Utils.rand(-2,2)),Utils.rand(0,100)>97){var a=Utils.rand(0,100);a>20?this.thrust=1:2>=a?this.thrust=-1:this.thrust=0}var b=Utils.rand(0,100);b>98&&(this.requestShoot=!0),10>b&&(this.requestShoot=!1)},MookActor.prototype.shoot=function(){this.weaponTimer+=20,this.manager.addNew({classId:ActorFactory.MOLTENPROJECTILE,positionX:this.body.position[0],positionY:this.body.position[1],angle:this.body.angle,velocity:100}),this.body.applyForceLocal([0,-4e3])},ShipActor.extend(BaseActor),ShipActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Convex({vertices:[[-4,0],[-1.5,-4],[1.5,-4],[4,0],[4,2.5],[0,5],[-4,2.5]],collisionGroup:Constants.COLLISION_GROUPS.SHIP,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN|Constants.COLLISION_GROUPS.ENEMYEXPLOSION}),actor:this,mass:4,damping:.75,angularDamping:0,inertia:10})},ShipActor.prototype.customUpdate=function(){this.processMovement(),this.processWeapon()},ShipActor.prototype.processMovement=function(){0!==this.rotationForce?this.body.angularVelocity=this.rotationForce*this.turnSpeed:this.body.angularVelocity=0,0!==this.thrust&&this.body.applyForceLocal([0,this.thrust*this.acceleration]),0!==this.horizontalThrust&&this.body.applyForceLocal([this.horizontalThrust*this.acceleration,0])},ShipActor.prototype.processWeapon=function(){this.primaryWeaponTimer>0&&this.primaryWeaponTimer--,this.requestShootPrimary&&0===this.primaryWeaponTimer&&this.shootPrimary(),this.secondaryWeaponTimer>0&&this.secondaryWeaponTimer--,this.requestShootSecondary&&0===this.secondaryWeaponTimer&&this.shootSecondary()},ShipActor.prototype.playerUpdate=function(a){this.applyThrustInput(a),this.applyRotationInput(a),this.applyWeaponInput(a)},ShipActor.prototype.applyRotationInput=function(a){this.rotationForce=0;var b=Utils.angleToVector(this.body.angle,1),c=Utils.vectorAngleToPoint(b[0],a.lookX-this.body.position[0],b[1],a.lookY-this.body.position[1]);180>c&&c>0&&(this.rotationForce=-1*Math.min(c/this.stepAngle,1)),c>=180&&360>c&&(this.rotationForce=Math.min((360-c)/this.stepAngle,1)),a.q&&(this.rotationForce=1),a.e&&(this.rotationForce=-1),this.lastInputStateX=a.lookX,this.lastInputStateY=a.lookY},ShipActor.prototype.applyThrustInput=function(a){this.thrust=0,this.horizontalThrust=0,a.a&&(this.horizontalThrust=-1*this.horizontalAccelerationRatio),a.d&&(this.horizontalThrust=1*this.horizontalAccelerationRatio),a.w&&(this.thrust=1),a.s&&(this.thrust=-1*this.backwardAccelerationRatio)},ShipActor.prototype.applyWeaponInput=function(a){this.requestShootPrimary=!!a.mouseLeft,this.requestShootSecondary=!!a.mouseRight},ShipActor.prototype.shootPrimary=function(){this.primaryWeaponTimer+=10;var a=Utils.angleToVector(this.body.angle+Utils.degToRad(90),4.5);this.manager.addNew({classId:ActorFactory.PLASMAPROJECTILE,positionX:this.body.position[0]+a[0],positionY:this.body.position[1]+a[1],angle:this.body.angle,velocity:200}),a=Utils.angleToVector(this.body.angle-Utils.degToRad(90),4.5),this.manager.addNew({classId:ActorFactory.PLASMAPROJECTILE,positionX:this.body.position[0]+a[0],positionY:this.body.position[1]+a[1],angle:this.body.angle,velocity:200})},ShipActor.prototype.shootSecondary=function(){this.secondaryWeaponTimer+=15;var a=Utils.angleToVector(this.body.angle+Utils.degToRad(140),3.5);this.manager.addNew({classId:ActorFactory.LASERPROJECITLE,positionX:this.body.position[0]+a[0],positionY:this.body.position[1]+a[1],angle:this.body.angle,velocity:300}),a=Utils.angleToVector(this.body.angle-Utils.degToRad(140),3.5),this.manager.addNew({classId:ActorFactory.LASERPROJECITLE,positionX:this.body.position[0]+a[0],positionY:this.body.position[1]+a[1],angle:this.body.angle,velocity:300})},ShipLaserProjectileActor.extend(BaseActor),ShipLaserProjectileActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Particle({collisionGroup:Constants.COLLISION_GROUPS.SHIPPROJECTILE,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN}),actor:this,mass:1,ccdSpeedThreshold:1,ccdIterations:4})},ShipLaserProjectileActor.prototype.onDeath=function(){this.body.dead=!0},ShipPlasmaProjectileActor.extend(BaseActor),ShipPlasmaProjectileActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Circle({radius:1,collisionGroup:Constants.COLLISION_GROUPS.SHIPPROJECTILE,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.ENEMYPROJECTILE|Constants.COLLISION_GROUPS.TERRAIN}),actor:this,mass:1,ccdSpeedThreshold:-1,ccdIterations:4})},ShipPlasmaProjectileActor.prototype.onDeath=function(){this.body.dead=!0},WallActor.extend(BaseActor),WallActor.prototype.createBody=function(){return new BaseBody({shape:new p2.Box({height:10,width:400,collisionGroup:Constants.COLLISION_GROUPS.TERRAIN,collisionMask:Constants.COLLISION_GROUPS.ENEMY|Constants.COLLISION_GROUPS.SHIPPROJECTILE|Constants.COLLISION_GROUPS.SHIP|Constants.COLLISION_GROUPS.ENEMYPROJECTILE}),actor:this,mass:0})},BaseBody.extend(p2.Body),BaseBody.prototype.createShape=function(){return new p2.Circle({radius:1})},BaseBody.prototype.initShape=function(){this.addShape(this.shape)},BaseBody.prototype.onDeath=function(){this.actor.remove(this.actorId)},BaseBody.prototype.onCollision=function(a){this.actor.onCollision(a.actor)},BaseBody.prototype.update=function(){},EnemyExplosionBody.extend(BaseBody),EnemyExplosionBody.prototype.createShape=function(){return new p2.Circle({radius:this.radius,collisionGroup:Constants.COLLISION_GROUPS.ENEMYEXPLOSION,collisionMask:Constants.COLLISION_GROUPS.SHIP})},EnemyExplosionBody.prototype.onDeath=function(){},EnemyExplosionBody.prototype.onCollision=function(a){},EnemyExplosionBody.prototype.update=function(){this.dead=!0},ShipExplosionBody.extend(BaseBody),ShipExplosionBody.prototype.createShape=function(){return new p2.Circle({radius:this.radius,collisionGroup:Constants.COLLISION_GROUPS.SHIPEXPLOSION,collisionMask:Constants.COLLISION_GROUPS.ENEMY})},ShipExplosionBody.prototype.onDeath=function(){},ShipExplosionBody.prototype.onCollision=function(a){},ShipExplosionBody.prototype.update=function(){this.dead=!0},ActorManager.prototype.addNew=function(a){if(Object.keys(this.storage).length>=Constants.STORAGE_SIZE)return void console.warn("Actor manager storage is full! Cannot create new Actor!");var b=this.factory.create(a);return b.manager=this,b.world=this.world,b.body.actorId=this.currentId,b.body.classId=a.classId,this.storage[this.currentId]=b,this.currentId++,this.world.addBody(b.body),b},ActorManager.prototype.update=function(a){this.playerActors.forEach(function(b){this.storage[b]&&this.storage[b].playerUpdate(a)}.bind(this));for(var b in this.storage)this.storage[b].update()},ActorManager.prototype.setPlayerActor=function(a){this.playerActors.push(a.body.actorId),this.core.renderBus.postMessage("attachPlayer",{actorId:a.body.actorId})},ActorManager.prototype.removeActorAt=function(a){delete this.storage[a]},ActorStorage.prototype.put=function(a){var b=void 0;return this.holes.length>0?b=this.holes.shift():(b=this.currentId,this.currentId++),this.storage[b]=a,b},ActorStorage.prototype.getAt=function(a){return this.storage[a]},ActorStorage.prototype.removeAt=function(a){delete this.storage[a],this.holes.push(a)};
//# sourceMappingURL=logic.min.map