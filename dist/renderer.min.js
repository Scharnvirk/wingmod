"use strict";function Init(){}function Camera(a){this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.VIEW_ANGLE=45,this.ASPECT=this.WIDTH/this.HEIGHT,this.NEAR=.1,this.FAR=1e4,a=a||{},Object.assign(this,a),THREE.PerspectiveCamera.call(this,this.VIEV_ANGLE,this.ASPECT,this.NEAR,this.FAR),this.position.z=300}function ControlsHandler(a){if(!a.inputListener)throw new Error("No inputListener specified for the handler!");if(!a.logicBus)throw new Error("No logic bus specified for the handler!");Object.assign(this,a),this.inputListener=a.inputListener,this.logicBus=a.logicBus,this.oldInputState={},this.inputState={}}function Core(a){if(!a)throw new Error("Logic core initialization failure!");this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.FRAMERATE=60,this.renderTicks=0,this.logicWorker=a,this.resolutionCoefficient=1,this.initRenderer(),this.initAssets()}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function LogicBus(a){if(a=a||{},Object.assign(this,a),!this.logicWorker)throw new Error("No logicWorker object specified for LogicBus!");if(!this.actorManager)throw new Error("No actorManager object specified for LogicBus!");this.logicWorker.onmessage=this.handleMessage.bind(this)}function BaseActor(a,b){Object.assign(this,b),this.positionZ=10,this.position=new Float32Array([0,0]),this.angle=0,this.logicPosition=new Float32Array([0,0]),this.logicPreviousPosition=new Float32Array([0,0]),this.logicAngle=0,this.logicPreviousAngle=0,this.updateFromLogic(a),this.mesh=this.createMesh(),this.light=this.createLight()}function LightActor(){BaseActor.apply(this,arguments)}function MookActor(){BaseActor.apply(this,arguments),this.particleOptions={position:new THREE.Vector3,positionRandomness:.3,velocity:new THREE.Vector3,velocityRandomness:3,color:16711680,colorRandomness:0,turbulence:.2,lifetime:2,size:4,sizeRandomness:1},this.particleOptions.position.z=this.positionZ}function ShipActor(){BaseActor.apply(this,arguments),this.particleOptions={position:new THREE.Vector3,positionRandomness:.3,velocity:new THREE.Vector3,velocityRandomness:5,color:16777215,colorRandomness:0,turbulence:.5,lifetime:3,size:8,sizeRandomness:1},this.particleOptions.position.z=this.positionZ}function WallActor(){BaseActor.apply(this,arguments)}function BaseLight(a){if(THREE.PointLight.apply(this,arguments),a=a||{},this.zOffset=10,this.distance=50,this.color=a.color||new THREE.Color(16777215),this.followActor=!0,Object.assign(this,a),this.color instanceof THREE.Color==!1)throw new Error("No color for a light!")}function BaseMesh(a){THREE.Mesh.apply(this,arguments),this.followActor=!0,this.angleOffset=0,a.scaleX=a.scaleX||1,a.scaleY=a.scaleY||1,a.scaleZ=a.scaleZ||1,a=a||{},Object.assign(this,a),this.scale.x=a.scaleX,this.scale.y=a.scaleY,this.scale.z=a.scaleZ}function ShipMesh(a){BaseMesh.apply(this,arguments),this.angleOffset=Math.PI,a=a||{},a.geometry=ModelStore.get("ship").geometry,a.material=ModelStore.get("ship").material,Object.assign(this,a)}function WallMesh(a){BaseMesh.apply(this,arguments),this.angleOffset=Math.PI,a=a||{},a.geometry=new THREE.BoxGeometry(400,2,50,50),a.material=new THREE.MeshLambertMaterial({color:16777215}),Object.assign(this,a)}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function ActorFactory(a){var b;this.actorDependencies=a,this.actorMap=(b={},_defineProperty(b,ActorFactory.SHIP_ACTOR,ShipActor),_defineProperty(b,ActorFactory.MOOK_ACTOR,MookActor),_defineProperty(b,ActorFactory.LIGHT_ACTOR,LightActor),_defineProperty(b,ActorFactory.WALL_ACTOR,WallActor),b)}function ActorManager(a){if(a=a||{},this.storage=Object.create(null),this.scene=null,this.particleSystem=null,this.framerate=a.framerate||60,this.DELTA_SMOOTHNESS=0,Object.assign(this,a),this.factory=a.factory||new ActorFactory({particleSystem:this.particleSystem}),this.currentPhysicsTime=Date.now(),this.lastPhysicsTime=Date.now()-1,!this.scene)throw new Error("No scene for Renderer ActorManager!")}function ActorStorage(a){this.storage=Array.apply(null,Array(a)).map(function(){}),this.holes=Array.apply(null,Array(a)).map(function(){})}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var gameCore;Init.prototype.start=function(){var a=new Worker("dist/logicInit.min.js"),b=new Core(a);gameCore=b};var Utils={makeRandomColor:function(){var a=["","",""];a.forEach(function(b,c){var d=Math.floor(256*Math.random()).toString(16);a[c]=1===d.length?"0"+d:d});var b="0x"+a.join("");return Number(b)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},getRandomFloat:function(a,b){if(a>b)throw"ERROR: getRandomFloat min > max";return Math.random()*(b-a)+a},getRandomInteger:function(a,b){if(a>b)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(b-a+1)+a)},rand:function(a,b){return this.getRandomInteger(a,b)},mixin:function(a,b){for(var c in b.prototype)a[c]=b.prototype[c]},uptrunc:function(a){return 0>a?Math.floor(a):Math.ceil(a)}};Function.prototype.extend||(Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype),this.prototype.constructor=a}),Camera.extend(THREE.PerspectiveCamera),Camera.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1]),this.inputListener&&(this.inputListener.inputState.scrollUp&&(this.position.z+=this.inputListener.inputState.scrollUp),this.inputListener.inputState.scrollDown&&(this.position.z-=this.inputListener.inputState.scrollDown))},ControlsHandler.prototype.update=function(){Object.assign(this.oldInputState,this.inputState),Object.assign(this.inputState,this.inputListener.inputState);var a=!1;for(var b in this.inputState)this.inputState[b]!=this.oldInputState[b]&&(a=!0);a&&this.sendUpdate()},ControlsHandler.prototype.sendUpdate=function(){this.logicBus.postMessage("inputState",this.inputState)},Core.prototype.initRenderer=function(){this.renderer=this.makeRenderer(),this.inputListener=new InputListener(this.renderer.domElement),this.camera=this.makeCamera(this.inputListener),this.particleSystem=this.makeParticleSystem(),this.scene=this.makeScene(this.particleSystem,this.camera),this.actorManager=new ActorManager({scene:this.scene,core:this,particleSystem:this.particleSystem}),this.logicBus=new LogicBus({logicWorker:this.logicWorker,actorManager:this.actorManager}),this.controlsHandler=new ControlsHandler({inputListener:this.inputListener,logicBus:this.logicBus}),this.startTime=Date.now(),this.gameScene=new GameScene({core:this,scene:this.scene,logicBus:this.logicBus,actorManager:this.actorManager}),this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="0px",this.autoResize(),document.body.appendChild(this.renderer.domElement),document.body.appendChild(this.stats.domElement)},Core.prototype.makeCamera=function(a){console.log("making camera");var b=new Camera({inputListener:a});return b},Core.prototype.makeParticleSystem=function(){return new THREE.GPUParticleSystem({maxParticles:2e4})},Core.prototype.makeScene=function(a,b){var c=new THREE.Scene;return c.add(a),c.add(b),c},Core.prototype.makeRenderer=function(){var a=new THREE.WebGLRenderer;return a.setSize(this.WIDTH,this.HEIGHT),a},Core.prototype.applyResolutionCoefficient=function(){this.renderer.setPixelRatio(this.resolutionCoefficient),this.resetRenderer(),this.resetCamera()},Core.prototype.autoResize=function(){var a=this,b=function(){a.resetRenderer(),a.resetCamera()};return window.addEventListener("resize",b,!1),{stop:function(){window.removeEventListener("resize",b)}}},Core.prototype.resetRenderer=function(){this.renderer.setSize(window.innerWidth,window.innerHeight)},Core.prototype.resetCamera=function(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},Core.prototype.initAssets=function(){this.modelLoader=new ModelLoader(ModelList.models),this.modelLoader.addEventListener("loaded",this.onLoaded.bind(this)),this.modelLoader.loadModels()},Core.prototype.onLoaded=function(a){ModelStore.loadBatch(this.modelLoader.getBatch()),this.modelLoader.clearBatch(),this.continueInit()},Core.prototype.continueInit=function(){this.gameScene.make(),setInterval(this.onEachSecond.bind(this),1e3);var a=new THREEx.RenderingLoop;a.add(this.render.bind(this)),a.start()},Core.prototype.onEachSecond=function(){this.renderTicks<58&&this.resolutionCoefficient>.4?(this.resolutionCoefficient-=.1,this.applyResolutionCoefficient()):60===this.renderTicks&&this.resolutionCoefficient<1&&(this.resolutionCoefficient+=.1,this.applyResolutionCoefficient()),this.renderTicks=0},Core.prototype.render=function(){this.inputListener.update(),this.controlsHandler.update(),this.gameScene.update(),this.actorManager.update(),this.camera.update(),this.renderTicks++,this.renderer.render(this.scene,this.camera),this.stats.update(),this.particleSystem.update((Date.now()-this.startTime)/1e3)};var InputListener=function a(b){function c(a,b){return function(){b.apply(a,arguments)}}function d(a){a.preventDefault()}_classCallCheck(this,a),this.scrollDuration=4,this.scrollFallOffPercent=10,this.domElement=void 0!==b?b:document,b&&this.domElement.setAttribute("tabindex",-1),this.inputState=Object.create(null),this.keys={87:"w",83:"s",65:"a",68:"d",37:"left",38:"up",39:"right",40:"down",1001:"scrollUp",1002:"scrollDown"},Object.keys(this.keys).forEach(function(a){this.inputState[this.keys[a]]=0}.bind(this)),this.keydown=function(a){a.altKey||this.keys.hasOwnProperty(a.keyCode)&&(this.inputState[this.keys[a.keyCode]]=1)},this.keyup=function(a){this.keys.hasOwnProperty(a.keyCode)&&(this.inputState[this.keys[a.keyCode]]=0)},this.mouseWheel=function(a){this.inputState.scrollUp=a.deltaY>0?this.scrollDuration:0,this.inputState.scrollDown=a.deltaY<0?this.scrollDuration:0},this.handleEvent=function(a){"function"==typeof this[a.type]&&this[a.type](a)},this.update=function(){for(var a in this.inputState)switch(a){case"scrollUp":case"scrollDown":this.inputState[a]>0&&(this.inputState[a]*=1-this.scrollFallOffPercent/100),this.inputState[a]<.5&&(this.inputState[a]=0)}},this.dispose=function(){this.domElement.removeEventListener("contextmenu",d,!1),this.domElement.removeEventListener("wheel",g,!1),window.removeEventListener("keydown",e,!1),window.removeEventListener("keyup",f,!1)};var e=c(this,this.keydown),f=c(this,this.keyup),g=c(this,this.mouseWheel);this.domElement.addEventListener("contextmenu",d,!1),this.domElement.addEventListener("wheel",g,!1),window.addEventListener("keydown",e,!1),window.addEventListener("keyup",f,!1)};LogicBus.prototype.handleMessage=function(a){switch(a.data.type){case"updateActors":this.actorManager.updateFromLogic(a.data);break;case"attachCamera":this.actorManager.attachCamera(a.data.actorId)}},LogicBus.prototype.postMessage=function(a,b){b.type=a,this.logicWorker.postMessage(b)},BaseActor.prototype.update=function(a){this.position[0]=this.logicPreviousPosition[0]+a*(this.logicPosition[0]-this.logicPreviousPosition[0]),this.position[1]=this.logicPreviousPosition[1]+a*(this.logicPosition[1]-this.logicPreviousPosition[1]),this.angle=this.logicPreviousAngle+a*(this.logicAngle-this.logicPreviousAngle),this.mesh&&this.mesh.update(),this.light&&this.light.update(),this.customUpdate()},BaseActor.prototype.customUpdate=function(){},BaseActor.prototype.updateFromLogic=function(a){this.logicPreviousPosition[0]=this.logicPosition[0],this.logicPreviousPosition[1]=this.logicPosition[1],this.logicPreviousAngle=this.logicAngle,this.logicPosition[0]=a[2]||0,this.logicPosition[1]=a[3]||0,this.logicAngle=a[4]||0},BaseActor.prototype.createMesh=function(){return null},BaseActor.prototype.createLight=function(){return null},BaseActor.prototype.addToScene=function(a){this.mesh&&a.add(this.mesh),this.light&&a.add(this.light)},BaseActor.prototype.removeFromScene=function(a){this.mesh&&a.remove(this.mesh),this.light&&a.remove(this.light)},LightActor.extend(BaseActor),LightActor.prototype.createLight=function(){return new BaseLight({actor:this,intensity:0})},MookActor.extend(BaseActor),MookActor.prototype.createMesh=function(){return new ShipMesh({actor:this})},MookActor.prototype.customUpdate=function(){var a=Math.abs(this.logicPosition[0]-this.logicPreviousPosition[0])+Math.abs(this.logicPosition[1]-this.logicPreviousPosition[1]);this.particleOptions.position.x=this.position[0],this.particleOptions.position.y=this.position[1];for(var b=1;a/2>b;b++)this.particleSystem.spawnParticle(this.particleOptions),this.particleSystem.spawnParticle(this.particleOptions)},ShipActor.extend(BaseActor),ShipActor.prototype.createMesh=function(){return new ShipMesh({actor:this,scaleX:4,scaleY:4,scaleZ:4})},ShipActor.prototype.customUpdate=function(){var a=Math.abs(this.logicPosition[0]-this.logicPreviousPosition[0])+Math.abs(this.logicPosition[1]-this.logicPreviousPosition[1]);this.particleOptions.position.x=this.position[0],this.particleOptions.position.y=this.position[1];for(var b=1;a>b;b++)this.particleSystem.spawnParticle(this.particleOptions),this.particleSystem.spawnParticle(this.particleOptions),this.particleSystem.spawnParticle(this.particleOptions),this.particleSystem.spawnParticle(this.particleOptions)},WallActor.extend(BaseActor),WallActor.prototype.createMesh=function(){return new WallMesh({actor:this})},BaseLight.extend(THREE.PointLight),BaseLight.prototype.update=function(){this.actor&&this.followActor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ+this.zOffset)},BaseMesh.extend(THREE.Mesh),BaseMesh.prototype.update=function(){this.actor&&this.followActor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ,this.rotation.z=this.actor.angle+this.angleOffset)},ShipMesh.extend(BaseMesh),WallMesh.extend(BaseMesh),ActorFactory.SHIP_ACTOR=1,ActorFactory.MOOK_ACTOR=2,ActorFactory.LIGHT_ACTOR=3,ActorFactory.WALL_ACTOR=4,ActorFactory.prototype.create=function(a){return new this.actorMap[a[0]](a,this.actorDependencies)},ActorManager.prototype.update=function(){var a=(Date.now()-this.currentPhysicsTime)/(this.currentPhysicsTime-this.lastPhysicsTime);for(var b in this.storage)this.storage[b].update(isFinite(a)?Math.min(a,1):0)},ActorManager.prototype.updateFromLogic=function(a){this.lastPhysicsTime=this.currentPhysicsTime,this.currentPhysicsTime=Date.now();for(var b=a.transferArray,c=0;c<a.length;c++)this.storage[b[5*c]]?this.storage[b[5*c]].updateFromLogic([b[5*c],b[5*c+1],b[5*c+2],b[5*c+3],b[5*c+4]]):this.createActor([b[5*c],b[5*c+1],b[5*c+2],b[5*c+3],b[5*c+4]])},ActorManager.prototype.createActor=function(a){var b=a.shift(),c=this.factory.create(a);this.actorRequestingCamera&&this.actorRequestingCamera===b&&(this.core.camera.actor=c),this.storage[b]=c,c.addToScene(this.scene)},ActorManager.prototype.attachCamera=function(a){this.storage[a]?this.core.camera.actor=this.storage[a]:this.actorRequestingCamera=a};var ModelList={models:["/models/ship.json"]},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),ModelLoader=function(){function a(b){if(_classCallCheck(this,a),!b)throw"ERROR: No model paths have been specified for the loader!";this.modelPaths=b,this.batch={},this.loaded=!0,Utils.mixin(this,THREE.EventDispatcher)}return _createClass(a,[{key:"loadModels",value:function(){var a=this;if(!this.loaded)throw"ERROR: ModelLoader is still busy loading previous batch!";this.loaded=!1;var b=new THREE.JSONLoader;this.modelPaths.forEach(function(c,d){a.batch[a._getModelName(c)]={geometry:null,material:null,loaded:!1},b.load(c,function(b,d){var e=a.batch[a._getModelName(c)];e.geometry=b,e.material=d,e.loaded=!0,a.checkIfLoaded()&&a._doneAction()})})}},{key:"checkIfLoaded",value:function(){var a=!0;for(var b in this.batch)if(!this.batch[b].loaded)return a=!1,!1;return a}},{key:"getBatch",value:function(){return this.batch}},{key:"clearBatch",value:function(){this.batch={}}},{key:"_doneAction",value:function(){this.loaded=!0,this.dispatchEvent({type:"loaded"})}},{key:"_getModelName",value:function(a){var b=a.split(".")[0].split("/").pop();if(!b)throw"ERROR: Bad model path: "+a;return b}}]),a}(),ModelStore={_materials:{},_geometries:{},get:function(a){return{geometry:this._geometries[a],material:this._materials[a]}},loadBatch:function(a){console.log(this),Object.keys(a).forEach(function(b){this._addGeometry(b,a[b].geometry),this._addMaterial(b,a[b].material)}.bind(this))},_addGeometry:function(a,b){if(b instanceof THREE.Geometry!=!0)throw"ERROR - geometry not instance of THREE.Geometry";this._geometries[a]=b},_addMaterial:function(a,b){if(!b)throw"ERROR - no material specified";this._materials[a]=b instanceof Array?b[0]:b}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),GameScene=function(){function a(b){_classCallCheck(this,a),Object.assign(this,b),this.lightCounter=0}return _createClass(a,[{key:"makeWalls",value:function(){for(var a,b=[],c=new THREE.MeshLambertMaterial({color:16777215}),d=new THREE.BoxGeometry(10,100,10),e=0;100>e;e++)a=new THREE.Mesh(d,c),a.position.x=Utils.rand(-300,300),a.position.y=Utils.rand(-300,300),a.position.z=Utils.rand(0,5),a.rotateZ(Utils.degToRad(Utils.rand(0,360))),b.push(a);var f=new THREE.Geometry;return b.forEach(function(a){a.updateMatrix(),f.merge(a.geometry,a.matrix)}),new THREE.Mesh(f,c)}},{key:"make",value:function(){var a=new THREE.Geometry,b=new THREE.PlaneGeometry(1e3,1e3,100,100),c=new THREE.MeshLambertMaterial({color:16777215}),d=new THREE.Mesh(b,c);d.updateMatrix(),a.merge(d.geometry,d.matrix);var e=this.makeWalls();a.merge(e.geometry,e.matrix);var f=new THREE.Mesh(a,c);f.matrixAutoUpdate=!1,f.updateMatrix(),this.scene.add(f),this.emergencyLight=new THREE.PointLight(8912896,1,200),this.emergencyLight.position.set(0,0,50),this.scene.add(this.emergencyLight);for(var g=0;5>g;g++){var h=new THREE.PointLight(16777215,1,100);h.position.set(Utils.rand(-200,200),Utils.rand(-200,200),20),this.scene.add(h)}}},{key:"update",value:function(){}}]),a}();
//# sourceMappingURL=sourceMap.map