"use strict";function Init(){}function Camera(a){this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.VIEW_ANGLE=45,this.ASPECT=this.WIDTH/this.HEIGHT,this.NEAR=.1,this.FAR=1e4,a=a||{},Object.assign(this,a),THREE.PerspectiveCamera.call(this,this.VIEV_ANGLE,this.ASPECT,this.NEAR,this.FAR),this.position.z=300,this.mousePosition=new THREE.Vector3(0,0,1)}function ControlsHandler(a){if(!a.inputListener)throw new Error("No inputListener specified for the handler!");if(!a.logicBus)throw new Error("No logic bus specified for the handler!");Object.assign(this,a),this.inputListener=a.inputListener,this.logicBus=a.logicBus,this.oldInputState={},this.inputState={},this.camera=a.camera,this.mousePosition=new THREE.Vector3(0,0,1)}function Core(a){if(!a)throw new Error("Logic core initialization failure!");this.WIDTH=document.documentElement.clientWidth,this.HEIGHT=document.documentElement.clientHeight,this.FRAMERATE=60,this.renderTicks=0,this.logicWorker=a,this.resolutionCoefficient=1,this.initRenderer(),this.initAssets()}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function LogicBus(a){if(a=a||{},Object.assign(this,a),!this.logicWorker)throw new Error("No logicWorker object specified for LogicBus!");if(!this.actorManager)throw new Error("No actorManager object specified for LogicBus!");this.logicWorker.onmessage=this.handleMessage.bind(this)}function BaseActor(a,b,c,d){Object.assign(this,d),this.positionZ=10,this.position=new Float32Array([0,0]),this.logicPosition=new Float32Array([0,0]),this.logicPreviousPosition=new Float32Array([0,0]),this.logicAngle=0,this.logicPreviousAngle=0,this.angle=c||0,this.position[0]=a||0,this.position[1]=b||0,this.updateFromLogic(a,b,c),this.mesh=this.createMesh(),this.light=this.createLight(),this.sprite=this.createSprite(),this.timer=0}function LightActor(){BaseActor.apply(this,arguments)}function MookActor(){BaseActor.apply(this,arguments)}function ProjectileActor(){BaseActor.apply(this,arguments),this.colorR=Math.random(),this.colorG=Math.random(),this.colorB=Math.random()}function ShipActor(){BaseActor.apply(this,arguments),this.count=0}function WallActor(){BaseActor.apply(this,arguments)}function BaseLight(a){if(THREE.PointLight.apply(this,arguments),a=a||{},this.zOffset=30,this.distance=100,this.color=a.color||new THREE.Color(16777215),Object.assign(this,a),this.color instanceof THREE.Color==!1)throw new Error("No color for a light!")}function BaseMesh(a){THREE.Mesh.apply(this,arguments),this.angleOffset=0,a.scaleX=a.scaleX||1,a.scaleY=a.scaleY||1,a.scaleZ=a.scaleZ||1,a=a||{},Object.assign(this,a),this.scale.x=a.scaleX,this.scale.y=a.scaleY,this.scale.z=a.scaleZ}function RavierMesh(a){BaseMesh.apply(this,arguments),a=a||{},a.geometry=ModelStore.get("ravier").geometry,a.material=ModelStore.get("ravier").material,Object.assign(this,a),this.castShadow=!0}function ShipMesh(a){BaseMesh.apply(this,arguments),a=a||{},a.geometry=ModelStore.get("ship").geometry,a.material=ModelStore.get("ship").material,Object.assign(this,a),this.castShadow=!0}function WallMesh(a){BaseMesh.apply(this,arguments),this.angleOffset=Math.PI,a=a||{},a.geometry=new THREE.BoxGeometry(400,2,50,50),a.material=new THREE.MeshLambertMaterial({color:16711680}),Object.assign(this,a)}function BaseSprite(a){THREE.Sprite.apply(this,arguments),a=a||{},Object.assign(this,a)}function ProjectileSprite(a){BaseSprite.apply(this,arguments),a=a||{},a.material=ModelStore.get("projectile").material,Object.assign(this,a),this.scale.x=10,this.scale.y=10,this.scale.z=10}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function ActorFactory(a){var b;this.actorDependencies=a,this.actorMap=(b={},_defineProperty(b,ActorFactory.SHIP,ShipActor),_defineProperty(b,ActorFactory.MOOK,MookActor),_defineProperty(b,ActorFactory.LIGHT,LightActor),_defineProperty(b,ActorFactory.WALL,WallActor),_defineProperty(b,ActorFactory.PROJECTILE,ProjectileActor),b)}function ActorManager(a){if(a=a||{},this.storage=Object.create(null),this.scene=null,this.framerate=a.framerate||60,this.DELTA_SMOOTHNESS=0,Object.assign(this,a),!this.scene)throw new Error("No scene for Renderer ActorManager!");if(!this.particleManager)throw new Error("No particleManager for Renderer ActorManager!");this.factory=a.factory||new ActorFactory({particleManager:this.particleManager}),this.currentPhysicsTime=Date.now(),this.lastPhysicsTime=Date.now()-1}function ActorStorage(a){this.storage=Array.apply(null,Array(a)).map(function(){}),this.holes=Array.apply(null,Array(a)).map(function(){})}function CustomModelBuilder(){this.batch={},this.configuration=this.configure()}function ModelLoader(){this.batch={},Utils.mixin(this,THREE.EventDispatcher)}function ParticleConfigBuilder(){this.particleMaterialConfig={smokePuffAlpha:new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:(new THREE.TextureLoader).load("/gfx/smokePuffAlpha.png")}},vertexShader:ParticleShaders.vertexShader,fragmentShader:ParticleShaders.fragmentShader,transparent:!0}),particleAdd:new THREE.ShaderMaterial({uniforms:{map:{type:"t",value:(new THREE.TextureLoader).load("/gfx/particleAdd.png")}},vertexShader:ParticleShaders.vertexShader,fragmentShader:ParticleShaders.fragmentShader,blending:THREE.AdditiveBlending,transparent:!0})},this.particleGeneratorConfig={smokePuffAlpha:{material:this.particleMaterialConfig.smokePuffAlpha,maxParticles:2e3,positionZ:9},particleAdd:{material:this.particleMaterialConfig.particleAdd,maxParticles:5e3,positionZ:9}}}function ParticleGenerator(a){if(THREE.Points.apply(this,arguments),a=a||{},a.positionZ=a.positionZ||10,a.maxParticles=a.maxParticles||100,a.positionHiddenFromView=1e5,Object.assign(this,a),!this.material)throw new Error("No material defined for ParticleGenerator!");this.usedPoints=new Float32Array(this.maxParticles),this.nextPointer=0,this.geometry=this.createGeometry()}function ParticleManager(a){if(a=a||{},Object.assign(this,a),!this.scene)throw new Error("No scene specified for ParticleGenerator!");this.configBuilder=new ParticleConfigBuilder,this.configs=this.configBuilder.getAllConfigs(),this.generators={},this.buildGenerators()}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var gameCore;Init.prototype.start=function(){var a=new Worker("dist/logicInit.min.js"),b=new Core(a);gameCore=b};var Utils={makeRandomColor:function(){var a=["","",""];a.forEach(function(b,c){var d=Math.floor(256*Math.random()).toString(16);a[c]=1===d.length?"0"+d:d});var b="0x"+a.join("");return Number(b)},degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)},getRandomFloat:function(a,b){if(a>b)throw"ERROR: getRandomFloat min > max";return Math.random()*(b-a)+a},getRandomInteger:function(a,b){if(a>b)throw"ERROR: getRandomInteger min > max";return Math.floor(Math.random()*(b-a+1)+a)},rand:function(a,b){return this.getRandomInteger(a,b)},mixin:function(a,b){for(var c in b.prototype)a[c]=b.prototype[c]},uptrunc:function(a){return 0>a?Math.floor(a):Math.ceil(a)}};Function.prototype.extend||(Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype),this.prototype.constructor=a}),Camera.extend(THREE.PerspectiveCamera),Camera.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1]);var a=this.inputListener.inputState;this.inputListener&&this.actor&&(this.inputListener.inputState.scrollUp&&(this.position.z+=a.scrollUp),this.inputListener.inputState.scrollDown&&(this.position.z-=a.scrollDown))},ControlsHandler.prototype.update=function(){Object.assign(this.oldInputState,this.inputState),Object.assign(this.inputState,this.inputListener.inputState),this.setSceneMousePosition();var a=!1;for(var b in this.inputState)this.inputState[b]!=this.oldInputState[b]&&(a=!0);a&&this.sendUpdate()},ControlsHandler.prototype.sendUpdate=function(){this.logicBus.postMessage("inputState",this.inputState)},ControlsHandler.prototype.setSceneMousePosition=function(){if(this.camera){this.mousePosition.x=this.inputState.mouseX,this.mousePosition.y=this.inputState.mouseY,this.mousePosition.z=1,this.mousePosition.unproject(this.camera);var a=this.mousePosition.z/(this.mousePosition.z-this.camera.position.z);this.inputListener.inputState.lookX=this.mousePosition.x+(this.camera.position.x-this.mousePosition.x)*a,this.inputListener.inputState.lookY=this.mousePosition.y+(this.camera.position.y-this.mousePosition.y)*a}},Core.prototype.initRenderer=function(){this.makeMainComponents(),this.stats=this.makeStatsWatcher(),this.startTime=Date.now(),this.attachToDom(this.renderer,this.stats)},Core.prototype.makeMainComponents=function(){this.renderer=this.makeRenderer(),this.inputListener=new InputListener(this.renderer.domElement),this.camera=this.makeCamera(this.inputListener),this.scene=this.makeScene(this.camera),this.particleManager=new ParticleManager({scene:this.scene}),this.actorManager=new ActorManager({scene:this.scene,particleManager:this.particleManager,core:this}),this.logicBus=new LogicBus({logicWorker:this.logicWorker,actorManager:this.actorManager}),this.controlsHandler=new ControlsHandler({inputListener:this.inputListener,logicBus:this.logicBus,camera:this.camera}),this.gameScene=new GameScene({core:this,scene:this.scene,logicBus:this.logicBus,actorManager:this.actorManager})},Core.prototype.makeStatsWatcher=function(){var a=new Stats;return a.domElement.style.position="absolute",a.domElement.style.top="0px",a},Core.prototype.attachToDom=function(a,b){document.body.appendChild(a.domElement),document.body.appendChild(b.domElement),this.autoResize()},Core.prototype.makeCamera=function(a){console.log("making camera");var b=new Camera({inputListener:a});return b},Core.prototype.makeScene=function(a){var b=new THREE.Scene;return b.add(a),b},Core.prototype.makeRenderer=function(){var a=new THREE.WebGLRenderer;return a.setSize(this.WIDTH,this.HEIGHT),a.shadowMap.enabled=!0,a.shadowMap.type=THREE.BasicShadowMap,a},Core.prototype.applyResolutionCoefficient=function(){this.renderer.setPixelRatio(this.resolutionCoefficient),this.resetRenderer(),this.resetCamera()},Core.prototype.autoResize=function(){var a=this,b=function(){a.resetRenderer(),a.resetCamera()};return window.addEventListener("resize",b,!1),{stop:function(){window.removeEventListener("resize",b)}}},Core.prototype.resetRenderer=function(){this.renderer.setSize(window.innerWidth,window.innerHeight)},Core.prototype.resetCamera=function(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},Core.prototype.initAssets=function(){this.modelLoader=new ModelLoader,this.modelLoader.addEventListener("loaded",this.onLoaded.bind(this)),this.modelLoader.loadModels(ModelList.models),this.customModelBuilder=new CustomModelBuilder,this.customModelBuilder.loadModels(),ModelStore.loadBatch(this.customModelBuilder.getBatch())},Core.prototype.onLoaded=function(a){ModelStore.loadBatch(this.modelLoader.getBatch()),this.modelLoader.clearBatch(),this.continueInit()},Core.prototype.continueInit=function(){this.gameScene.make(),setInterval(this.onEachSecond.bind(this),1e3);var a=new THREEx.RenderingLoop;a.add(this.render.bind(this)),a.start();var b=new THREEx.PhysicsLoop(120);b.add(this.controlsUpdate.bind(this)),b.start()},Core.prototype.onEachSecond=function(){this.renderTicks=0},Core.prototype.controlsUpdate=function(){this.inputListener.update(),this.controlsHandler.update()},Core.prototype.render=function(){this.gameScene.update(),this.actorManager.update(),this.particleManager.update(),this.camera.update(),this.renderTicks++,this.renderer.render(this.scene,this.camera),this.stats.update()};var InputListener=function a(b){function c(a,b){return function(){b.apply(a,arguments)}}function d(a){a.preventDefault()}_classCallCheck(this,a),this.scrollDuration=4,this.scrollFallOffPercent=10,this.domElement=void 0!==b?b:document,b&&this.domElement.setAttribute("tabindex",-1),this.inputState=Object.create(null),this.keys={81:"q",69:"e",87:"w",83:"s",65:"a",68:"d",37:"left",38:"up",39:"right",40:"down",1001:"scrollUp",1002:"scrollDown"},Object.keys(this.keys).forEach(function(a){this.inputState[this.keys[a]]=0}.bind(this)),this.keydown=function(a){a.altKey||this.keys.hasOwnProperty(a.keyCode)&&(this.inputState[this.keys[a.keyCode]]=1)},this.keyup=function(a){this.keys.hasOwnProperty(a.keyCode)&&(this.inputState[this.keys[a.keyCode]]=0)},this.mouseWheel=function(a){this.inputState.scrollUp=a.deltaY>0?this.scrollDuration:0,this.inputState.scrollDown=a.deltaY<0?this.scrollDuration:0},this.mouseMove=function(a){this.inputState.mouseX=a.clientX/window.innerWidth*2-1,this.inputState.mouseY=2*-(a.clientY/window.innerHeight)+1},this.handleEvent=function(a){"function"==typeof this[a.type]&&this[a.type](a)},this.update=function(){for(var a in this.inputState)switch(a){case"scrollUp":case"scrollDown":this.inputState[a]>0&&(this.inputState[a]*=1-this.scrollFallOffPercent/100),this.inputState[a]<.5&&(this.inputState[a]=0)}},this.dispose=function(){this.domElement.removeEventListener("contextmenu",d,!1),this.domElement.removeEventListener("wheel",g,!1),this.domElement.removeEventListener("mousemove",g,!1),window.removeEventListener("keydown",e,!1),window.removeEventListener("keyup",f,!1)};var e=c(this,this.keydown),f=c(this,this.keyup),g=c(this,this.mouseWheel),h=c(this,this.mouseMove);this.domElement.addEventListener("contextmenu",d,!1),this.domElement.addEventListener("wheel",g,!1),this.domElement.addEventListener("mousemove",h,!1),window.addEventListener("keydown",e,!1),window.addEventListener("keyup",f,!1)};LogicBus.prototype.handleMessage=function(a){switch(a.data.type){case"updateActors":this.actorManager.updateFromLogic(a.data);break;case"attachCamera":this.actorManager.attachCamera(a.data.actorId)}},LogicBus.prototype.postMessage=function(a,b){b.type=a,this.logicWorker.postMessage(b)},BaseActor.prototype.update=function(a){this.timer++,this.position[0]=this.logicPreviousPosition[0]+a*(this.logicPosition[0]-this.logicPreviousPosition[0]),this.position[1]=this.logicPreviousPosition[1]+a*(this.logicPosition[1]-this.logicPreviousPosition[1]),this.angle=this.logicPreviousAngle+a*(this.logicAngle-this.logicPreviousAngle),this.mesh&&this.mesh.update(),this.light&&this.light.update(),this.sprite&&this.sprite.update(),this.customUpdate()},BaseActor.prototype.customUpdate=function(){},BaseActor.prototype.updateFromLogic=function(a,b,c){this.logicPreviousPosition[0]=this.logicPosition[0],this.logicPreviousPosition[1]=this.logicPosition[1],this.logicPreviousAngle=this.logicAngle,this.logicPosition[0]=a||0,this.logicPosition[1]=b||0,this.logicAngle=c||0},BaseActor.prototype.createMesh=function(){return null},BaseActor.prototype.createLight=function(){return null},BaseActor.prototype.createSprite=function(){return null},BaseActor.prototype.addToScene=function(a){this.mesh&&a.add(this.mesh),this.light&&a.add(this.light),this.sprite&&a.add(this.sprite)},BaseActor.prototype.removeFromScene=function(a){this.mesh&&a.remove(this.mesh),this.light&&a.remove(this.light),this.sprite&&a.remove(this.sprite)},BaseActor.prototype.onDeath=function(){},LightActor.extend(BaseActor),LightActor.prototype.createLight=function(){return new BaseLight({actor:this,intensity:0})},MookActor.extend(BaseActor),MookActor.prototype.createMesh=function(){return new ShipMesh({actor:this,scaleX:2,scaleY:2,scaleZ:2})},ProjectileActor.extend(BaseActor),ProjectileActor.prototype.customUpdate=function(){this.particleManager.createParticle("particleAdd",this.position[0],this.position[1],1,1,1,5,.5,120),this.particleManager.createParticle("particleAdd",this.position[0],this.position[1],this.colorR,this.colorG,this.colorB,20,.1,2)},ProjectileActor.prototype.onDeath=function(){for(var a=0;10>a;a++)this.particleManager.createParticle("smokePuffAlpha",this.position[0]+Utils.rand(-5,5),this.position[1]+Utils.rand(-5,5),this.colorR,this.colorG,this.colorB,Utils.rand(5,20),.2,60);this.particleManager.createParticle("particleAdd",this.position[0],this.position[1],this.colorR,this.colorG,this.colorB,80,.3,2),this.particleManager.createParticle("particleAdd",this.position[0],this.position[1],this.colorR,this.colorG,this.colorB,20,1,20)},ShipActor.extend(BaseActor),ShipActor.prototype.createMesh=function(){return new RavierMesh({actor:this,scaleX:6,scaleY:6,scaleZ:6})},ShipActor.prototype.customUpdate=function(){this.timer%3===0&&this.particleManager.createParticle("smokePuffAlpha",this.position[0]+Utils.rand(-3,3),this.position[1]+Utils.rand(-3,3),1,1,1,Utils.rand(5,20),.5,60)},WallActor.extend(BaseActor),WallActor.prototype.createMesh=function(){return new WallMesh({actor:this})},BaseLight.extend(THREE.PointLight),BaseLight.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ+this.zOffset)},BaseMesh.extend(THREE.Mesh),BaseMesh.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ,this.rotation.z=this.actor.angle+this.angleOffset)},RavierMesh.extend(BaseMesh),ShipMesh.extend(BaseMesh),WallMesh.extend(BaseMesh),BaseSprite.extend(THREE.Sprite),BaseSprite.prototype.update=function(){this.actor&&(this.position.x=this.actor.position[0],this.position.y=this.actor.position[1],this.position.z=this.actor.positionZ)},ProjectileSprite.extend(BaseSprite),ActorFactory.SHIP=1,ActorFactory.MOOK=2,ActorFactory.LIGHT=3,ActorFactory.WALL=4,ActorFactory.PROJECTILE=100,ActorFactory.prototype.create=function(a,b,c,d){return new this.actorMap[a](b,c,d,this.actorDependencies)},ActorManager.prototype.update=function(){var a=(Date.now()-this.currentPhysicsTime)/(this.currentPhysicsTime-this.lastPhysicsTime);for(var b in this.storage)this.storage[b].update(isFinite(a)?Math.min(a,1):0)},ActorManager.prototype.updateFromLogic=function(a){this.lastPhysicsTime=this.currentPhysicsTime,this.currentPhysicsTime=Date.now();for(var b=a.transferArray,c=a.deadActors,d=0;d<a.length;d++){var e=this.storage[b[5*d]];e?e.updateFromLogic(b[5*d+2],b[5*d+3],b[5*d+4]):b[5*d+1]>0&&this.createActor(b[5*d],b[5*d+1],b[5*d+2],b[5*d+3],b[5*d+4])}for(var d=0;d<c.length;d++)this.deleteActor(c[d])},ActorManager.prototype.createActor=function(a,b,c,d,e){var f=this.factory.create(b,c,d,e);this.actorRequestingCamera&&this.actorRequestingCamera===a&&(this.core.camera.actor=f,this.core.gameScene.actor=f),this.storage[a]=f,f.addToScene(this.scene)},ActorManager.prototype.attachCamera=function(a){this.storage[a]?this.core.camera.actor=this.storage[a]:this.actorRequestingCamera=a},ActorManager.prototype.deleteActor=function(a){var b=this.storage[a];b&&(b.onDeath(),b.removeFromScene(this.scene)),delete this.storage[a]},CustomModelBuilder.prototype.configure=function(){return{projectile:{material:new THREE.SpriteMaterial({map:THREE.ImageUtils.loadTexture("/gfx/particleAdd.png"),color:16777215,blending:THREE.AdditiveBlending})}}},CustomModelBuilder.prototype.loadModels=function(){var a=this;Object.keys(this.configuration).forEach(function(b){a.batch[b]={geometry:a.configuration[b].geometry,material:a.configuration[b].material}})},CustomModelBuilder.prototype.getBatch=function(){return this.batch},ModelLoader.prototype.clearBatch=function(){this.batch={}};var ModelList={models:["/models/ship.json","/models/ravier.json"]};ModelLoader.prototype.loadModels=function(a){var b=this;if(!a)throw"ERROR: No model paths have been specified for the loader!";var c=new THREE.JSONLoader;Promise.all(a.map(function(a){var d=new Promise(function(d,e){c.load(a,function(c,e){b.batch[b.getModelName(a)]={geometry:c,material:e},d()},b.getDefaultTexturePath(a))});return d})).then(this.doneAction.bind(this))},ModelLoader.prototype.getBatch=function(){return this.batch},ModelLoader.prototype.clearBatch=function(){this.batch={}},ModelLoader.prototype.doneAction=function(){this.dispatchEvent({type:"loaded"})},ModelLoader.prototype.getModelName=function(a){var b=a.split(".")[0].split("/").pop();if(!b)throw"ERROR: Bad model path: "+a;return b},ModelLoader.prototype.getDefaultTexturePath=function(a){return a.replace("json","png")};var ModelStore={_materials:{},_geometries:{},get:function(a){return{geometry:this._geometries[a],material:this._materials[a]}},loadBatch:function(a){Object.keys(a).forEach(function(b){this._addGeometry(b,a[b].geometry),this._addMaterial(b,a[b].material)}.bind(this))},_addGeometry:function(a,b){this._geometries[a]=b},_addMaterial:function(a,b){if(!b)throw"ERROR - no material specified";this._materials[a]=b instanceof Array?b[0]:b}};ParticleConfigBuilder.prototype.getConfig=function(a){return this.particleGeneratorConfig[a]},ParticleConfigBuilder.prototype.getAllConfigs=function(){return this.particleGeneratorConfig},ParticleGenerator.extend(THREE.Points),ParticleGenerator.prototype.createGeometry=function(){for(var a=new THREE.BufferGeometry,b=new Float32Array(3*this.maxParticles),c=new Float32Array(3*this.maxParticles),d=new Float32Array(1*this.maxParticles),e=new Float32Array(1*this.maxParticles),f=new Float32Array(1*this.maxParticles),g=0;g<this.maxParticles;g++)b[3*g+0]=Utils.rand(-this.positionHiddenFromView,this.positionHiddenFromView),b[3*g+1]=Utils.rand(-this.positionHiddenFromView,this.positionHiddenFromView),b[3*g+2]=this.positionZ,f[g]=-1;return a.addAttribute("position",new THREE.BufferAttribute(b,3)),a.addAttribute("alpha",new THREE.BufferAttribute(d,1)),a.addAttribute("color",new THREE.BufferAttribute(c,3)),a.addAttribute("scale",new THREE.BufferAttribute(e,1)),a.lifeTime=f,a},ParticleGenerator.prototype.create=function(a,b,c,d,e,f,g,h){var i=this.nextPointer;this.nextPointer++,this.nextPointer>this.maxParticles&&(this.nextPointer=0),this.initParticle(i,a,b,c,d,e,f,g,h)},ParticleGenerator.prototype.deactivate=function(a){this.geometry.attributes.position.array[3*a]=this.positionHiddenFromView,this.geometry.attributes.position.array[3*a+1]=this.positionHiddenFromView},ParticleGenerator.prototype.update=function(){for(var a=0;a<this.maxParticles;a++)this.updateParticle(a);this.geometry.attributes.alpha.needsUpdate=!0,this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.attributes.scale.needsUpdate=!0},ParticleGenerator.prototype.updateParticle=function(a){var b=this.geometry.lifeTime;0===b[a]?this.deactivate(a):(this.geometry.attributes.alpha.array[a]*=.95,b[a]-=1)},ParticleGenerator.prototype.initParticle=function(a,b,c,d,e,f,g,h,i){var j=this.geometry.attributes;j.position.array[3*a]=b,j.position.array[3*a+1]=c,j.color.array[3*a]=d,j.color.array[3*a+1]=e,j.color.array[3*a+2]=f,j.scale.array[a]=g,j.alpha.array[a]=h,this.geometry.lifeTime[a]=i},ParticleManager.prototype.buildGenerators=function(){var a=this;Object.keys(this.configs).forEach(function(b){var c=new ParticleGenerator(a.configs[b]);a.generators[b]=c,a.scene.add(c)})},ParticleManager.prototype.getGenerator=function(a){return this.generators[a]},ParticleManager.prototype.update=function(){for(var a in this.generators)this.generators[a].update()},ParticleManager.prototype.createParticle=function(a,b,c,d,e,f,g,h,i){this.generators[a].create(b,c,d,e,f,g,h,i)};var ParticleShaders={vertexShader:"         attribute float alpha;         attribute vec3 color;         varying float vAlpha;         varying vec3 vColor;         attribute float scale;         void main() {             vAlpha = alpha;             vColor = color;             vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );             gl_PointSize =  scale * (1000.0 / - mvPosition.z) ;             gl_Position = projectionMatrix * mvPosition;         }",fragmentShader:"         uniform sampler2D map;         varying vec3 vColor;         varying float vAlpha;         void main() { 			gl_FragColor = vec4(vColor, vAlpha) * texture2D( map, gl_PointCoord );         }     "},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),GameScene=function(){function a(b){_classCallCheck(this,a),Object.assign(this,b),this.lightCounter=0}return _createClass(a,[{key:"makeWalls",value:function(){for(var a,b=[],c=new THREE.MeshLambertMaterial({color:16777215}),d=new THREE.BoxGeometry(10,100,10),e=0;100>e;e++)a=new THREE.Mesh(d,c),a.position.x=Utils.rand(-300,300),a.position.y=Utils.rand(-300,300),a.position.z=Utils.rand(0,2),a.rotateZ(Utils.degToRad(Utils.rand(0,360))),b.push(a);var f=new THREE.Geometry;return b.forEach(function(a){a.updateMatrix(),f.merge(a.geometry,a.matrix)}),new THREE.Mesh(f,c)}},{key:"make",value:function(){var a=new THREE.Geometry,b=THREE.ImageUtils.loadTexture("/models/floor.png");b.wrapS=b.wrapT=THREE.RepeatWrapping,b.repeat.set(10,10);var c=new THREE.PlaneGeometry(1e3,1e3,2,2),d=new THREE.MeshPhongMaterial({color:8947848,map:b}),e=new THREE.Mesh(c,d);e.updateMatrix(),a.merge(e.geometry,e.matrix);var f=this.makeWalls();a.merge(f.geometry,f.matrix);var g=new THREE.Mesh(a,d);g.receiveShadow=!0,g.castShadow=!0,g.matrixAutoUpdate=!1,g.updateMatrix(),this.scene.add(g);var h=new THREE.DirectionalLight(16777215,.2);h.position.set(2,2,10),this.scene.add(h),this.pointLight=new THREE.PointLight(16777215,1),this.pointLight.distance=200,this.pointLight.castShadow=!0,this.pointLight.shadowCameraNear=1,this.pointLight.shadowCameraFar=250,this.pointLight.shadowMapWidth=2048,this.pointLight.shadowMapHeight=2048,this.pointLight.shadowBias=0,this.pointLight.shadowDarkness=.4,this.pointLight.position.set(0,0,50),this.scene.add(this.pointLight),this.geometries=[]}},{key:"update",value:function(){this.actor&&(this.pointLight.position.x=this.actor.position[0]+20,this.pointLight.position.y=this.actor.position[1]+20)}},{key:"enableShadows",value:function(a){this.pointLight&&(this.pointLight.castShadow=a)}}]),a}();
//# sourceMappingURL=renderer.min.map